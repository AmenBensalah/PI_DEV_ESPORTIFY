{% extends 'base.html.twig' %}

{% block body %}

<div class="feed-layout">
    <section class="feed-main">
        <div class="feed-title">Fil d'actualité</div>

        <article class="glass-card composer"
                 data-composer-front
                 data-post-url="{{ path('fil_post_create') }}"
                 data-csrf-token="{{ csrf_token('fil_post_create') }}"
                 data-event-token="{{ csrf_token('event_participate') }}"
                 data-like-token="{{ csrf_token('post_like') }}"
                 data-comment-token="{{ csrf_token('post_comment') }}"
                 data-save-token="{{ csrf_token('post_save') }}">
            <div class="composer-header">
                <div class="avatar">V</div>
                <strong>Vous</strong>
            </div>
            <textarea class="composer-input" placeholder="Publier un message, une image ou un lien vidéo..." data-content></textarea>
            <div class="admin-media-preview" data-media-preview></div>
            <div class="composer-video-row" data-video-row>
                <label class="admin-form-label">
                    <i class="fas fa-video"></i> Lien vidéo
                </label>
                <input class="admin-form-input" type="url" placeholder="https://..." data-video-url>
            </div>
            <div class="composer-actions">
                <div class="action-group">
                    <button class="chip-btn" type="button" data-media-button="image"><i class="fa-regular fa-image"></i> Image</button>
                    <button class="chip-btn" type="button" data-video-toggle><i class="fa-solid fa-video"></i> Lien vidéo</button>
                    <button class="chip-btn" type="button" data-event-toggle><i class="fa-solid fa-bolt"></i> EVENT</button>
                </div>
                <button class="publish-btn" type="button" data-publish-button>Publier</button>
            </div>
            <input type="hidden" data-is-event value="0">
            <input type="hidden" data-image-path>
            <input type="file" class="admin-file-input" data-media-file accept="image/*">

            <div class="event-accordion" data-event-accordion>
                <div class="event-accordion-header">
                    <div class="event-accordion-title">
                        <i class="fas fa-trophy"></i> Détails de l'événement
                    </div>
                    <div class="event-accordion-subtitle">Renseignez les informations pour créer un post événement.</div>
                </div>
                <div class="admin-form-grid">
                    <div class="admin-form-group">
                        <label class="admin-form-label">
                            <i class="fas fa-trophy"></i> Titre de l'événement
                        </label>
                        <input class="admin-form-input" type="text" placeholder="Tournoi Hebdo, Tryouts, Scrim..." data-event-title>
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-form-label">
                            <i class="fas fa-calendar-alt"></i> Date et heure
                        </label>
                        <input class="admin-form-input" type="datetime-local" data-event-date>
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-form-label">
                            <i class="fas fa-location-dot"></i> Lieu / Lien
                        </label>
                        <input class="admin-form-input" type="text" placeholder="Salle, Discord, Lien..." data-event-location>
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-form-label">
                            <i class="fas fa-users"></i> Nombre de places
                        </label>
                        <input class="admin-form-input" type="number" min="1" placeholder="16" data-event-max>
                    </div>
                </div>
            </div>
        </article>

        <div class="glass-card">
            <div class="filters">
                <button class="filter-pill active" type="button">Tout</button>
                <button class="filter-pill" type="button">Équipes</button>
                <button class="filter-pill" type="button">Joueurs</button>
                <button class="filter-pill" type="button">Tournois</button>
                <button class="filter-pill" type="button">Média</button>
            </div>
        </div>

        <div id="post-list">
            {% if posts is empty %}
                <div class="glass-card post-card" id="post-empty">
                    <div class="post-content">Aucune publication pour le moment.</div>
                </div>
            {% else %}
                {% for post in posts %}
                    {% set isSaved = savedIds is defined and post.id in savedIds %}
                    <article class="glass-card post-card {{ post.isEvent ? 'event-card' : '' }}"
                             data-post-id="{{ post.id }}"
                             id="post-{{ post.id }}"
                             data-like-url="{{ path('fil_post_like', {id: post.id}) }}"
                             data-comment-url="{{ path('fil_post_comment', {id: post.id}) }}"
                             data-save-url="{{ path('fil_post_save', {id: post.id}) }}"
                             data-saved="{{ isSaved ? '1' : '0' }}">
                        <div class="post-header">
                            <div class="avatar">U</div>
                            <div class="post-meta">
                                <div class="post-author">{{ post.author ? (post.author.pseudo ?: post.author.nom) : 'Utilisateur' }}</div>
                                <div class="post-time">
                                    {{ post.createdAt ? post.createdAt|date('d/m/Y H:i') : 'Maintenant' }}
                                </div>
                            </div>
                        </div>
                        {% if post.isEvent %}
                            <div class="event-header">
                                <div class="event-date">
                                    {{ post.eventDate ? post.eventDate|date('d/m/Y H:i') : 'À confirmer' }}
                                </div>
                                <div class="event-title">{{ post.eventTitle ? post.eventTitle|upper : 'ÉVÉNEMENT' }}</div>
                                {% if post.eventLocation %}
                                    <div class="event-location"><i class="fas fa-location-dot"></i> {{ post.eventLocation }}</div>
                                {% endif %}
                            </div>
                        {% endif %}
                        {% if post.content %}
                            <div class="post-content">{{ post.content }}</div>
                        {% endif %}

                        {% if post.imagePath %}
                            <div class="post-media">
                                <img src="{{ asset(post.imagePath starts with 'http' ? post.imagePath : 'uploads/' ~ post.imagePath) }}" alt="media">
                            </div>
                        {% elseif post.videoUrl %}
                            {% set video = post.videoUrl %}
                            {% set isDirect = video matches '/\\.(mp4|webm|ogg)$/i' %}
                            {% set youtubeId = video matches '/(youtu\\.be\\/|v=)([\\w-]{6,})/i' ? (video|replace({'https://youtu.be/':''})|split('?')|first) : '' %}
                            {% set embedUrl = '' %}
                            {% if video matches '/youtube\\.com|youtu\\.be/' and youtubeId %}
                                {% set embedUrl = 'https://www.youtube.com/embed/' ~ youtubeId %}
                            {% elseif video matches '/vimeo\\.com/' %}
                                {% set vimeoId = video|split('/')|last %}
                                {% set embedUrl = 'https://player.vimeo.com/video/' ~ vimeoId %}
                            {% endif %}
                            <div class="post-media">
                                {% if isDirect %}
                                    <video controls>
                                        <source src="{{ video }}">
                                    </video>
                                {% elseif embedUrl %}
                                    <iframe class="video-embed" src="{{ embedUrl }}" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
                                {% else %}
                                    <a class="media-placeholder" href="{{ video }}" target="_blank" rel="noopener">Voir la vidéo</a>
                                {% endif %}
                            </div>
                        {% endif %}

                        {% if post.isEvent %}
                            <div class="event-actions">
                                <button class="event-join-btn" type="button"
                                        data-event-join
                                        data-url="{{ path('fil_event_participate', {id: post.id}) }}"
                                        data-count="{{ post.participantsCount }}"
                                        data-max="{{ post.maxParticipants ?? '' }}">
                                    Participer
                                    <span class="event-join-count">
                                        <span data-count>{{ post.participantsCount }}</span>
                                        {% if post.maxParticipants %}/<span data-max>{{ post.maxParticipants }}</span>{% endif %}
                                    </span>
                                </button>
                            </div>
                        {% endif %}

                        <div class="post-actions">
                            <div class="reaction-row">
                                <button class="reaction-pill" type="button" data-like-button>
                                    <i class="fa-regular fa-heart"></i> J'aime
                                    <span class="reaction-count" data-like-count>{{ post.likes|length }}</span>
                                </button>
                                <button class="reaction-pill" type="button" data-comment-trigger><i class="fa-regular fa-comment"></i> Commenter</button>
                                <button class="reaction-pill" type="button" data-share-button><i class="fa-solid fa-share"></i> Partager</button>
                            </div>
                            <div class="reaction-row">
                                <button class="reaction-pill {{ isSaved ? 'is-saved' : '' }}" type="button" data-save-button>
                                    <i class="fa-regular fa-bookmark"></i> {{ isSaved ? 'Enregistré' : 'Sauvegarder' }}
                                </button>
                            </div>
                        </div>
                        <div class="comment-list" data-comment-list>
                            {% for comment in post.commentaires %}
                                <div class="comment-item">
                                    <strong>{{ comment.author ? (comment.author.pseudo ?: comment.author.nom) : 'Utilisateur' }}</strong>
                                    <span class="comment-text">{{ comment.content }}</span>
                                    <span class="comment-time">{{ comment.createdAt|date('d/m/Y H:i') }}</span>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="comment-box">
                            <input class="comment-input" placeholder="Ajouter un commentaire..." data-comment-input />
                            <button class="comment-send" type="button" data-comment-send>Envoyer</button>
                        </div>
                    </article>
                {% endfor %}
            {% endif %}
        </div>
    </section>

    <aside class="feed-right">
        <div class="admin-tournament-panel announce-panel">
            <div class="admin-tournament-panel-title">
                <i class="fas fa-bullhorn"></i> Annonces officielles
            </div>
            {% if announcements is empty %}
                <div class="announce-item clean">
                    <div class="title">Aucune annonce</div>
                    <div class="meta">Ajoutez des annonces depuis l'espace admin.</div>
                </div>
            {% else %}
                {% for announcement in announcements %}
                    <div class="announce-item clean">
                        <div class="announce-row">
                            <div class="title">{{ announcement.title }}</div>
                            {% if announcement.tag %}
                                <div class="tag">{{ announcement.tag }}</div>
                            {% endif %}
                        </div>
                        {% if announcement.mediaType == 'image' and announcement.mediaFilename %}
                            <div class="announce-media">
                                <img src="{{ asset(announcement.mediaFilename starts with 'http' ? announcement.mediaFilename : 'uploads/' ~ announcement.mediaFilename) }}" alt="media">
                            </div>
                        {% elseif announcement.title|lower == 'oppenning' %}
                            <div class="announce-media">
                                <img src="{{ asset('images/esportify-card.jpg') }}" alt="E-Sportify">
                            </div>
                        {% elseif announcement.mediaType == 'video' and announcement.mediaFilename %}
                            <div class="announce-media">
                                <video controls>
                                    <source src="{{ asset(announcement.mediaFilename starts with 'http' ? announcement.mediaFilename : 'uploads/' ~ announcement.mediaFilename) }}">
                                </video>
                            </div>
                        {% elseif announcement.mediaType == 'link' and announcement.mediaFilename %}
                            <div class="announce-media">
                                <div class="media-placeholder">{{ announcement.mediaFilename }}</div>
                            </div>
                        {% endif %}
                        <div class="meta">
                            {{ announcement.createdAt ? announcement.createdAt|date('d/m/Y H:i') : '' }}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </aside>
</div>

{% endblock %}
