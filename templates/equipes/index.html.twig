{% extends 'base.html.twig' %}

{% block body_class %}page-equipes{% endblock %}

{% block title %}Équipes - E-Sportify{% endblock %}

{% block body %}
<div class="equipes-content equipes-hub">
    {% for message in app.flashes('success') %}
        <div class="flash-success" role="status" aria-live="polite" style="margin:12px 0;">
            <i class="fas fa-check-circle" style="color: var(--success-color); font-size: 18px; margin-right:10px;"></i>
            <span style="color: var(--success-color); font-weight:600;">{{ message }}</span>
        </div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="flash-error" role="status" aria-live="polite" style="margin:12px 0; background: rgba(255,0,110,0.06); border:1px solid var(--primary-pink); padding:10px 12px; border-radius:8px;">
            <i class="fas fa-exclamation-circle" style="color: var(--primary-pink); font-size: 18px; margin-right:10px;"></i>
            <span style="color: var(--primary-pink); font-weight:600;">{{ message }}</span>
        </div>
    {% endfor %}

    <section class="admin-tournament-hero team-hub-hero">
        <div class="admin-tournament-hero-inner">
            <div class="admin-tournament-kicker">HUB ÉQUIPES</div>
            <h1 class="admin-tournament-title">HUB ÉQUIPES</h1>
            <p class="admin-tournament-lead team-description">
                Explorez les rosters, suivez les performances et trouvez votre place dans l’élite E‑sport.
            </p>
            <div class="admin-tournament-hero-actions team-hub-actions">
                {% if myTeam %}
                    <a href="{{ path('app_equipes_show', {'id': myTeam.id}) }}" class="admin-tournament-btn">
                        <i class="fas fa-eye"></i> Voir mon équipe
                    </a>
                {% elseif memberTeam %}
                    <a href="{{ path('app_equipes_show', {'id': memberTeam.id}) }}" class="admin-tournament-btn">
                        <i class="fas fa-eye"></i> Voir mon équipe
                    </a>
                {% endif %}

                {% if canCreateTeam %}
                    <a href="{{ path('app_equipes_new') }}" class="admin-tournament-btn">
                        <i class="fas fa-plus-circle"></i> Créer mon équipe
                    </a>
                {% endif %}
                {% if not myTeam and not memberTeam and not canCreateTeam %}
                    {% if canRequestManager %}
                        <a href="{{ path('app_become_manager') }}" class="admin-tournament-btn ghost">
                            <i class="fas fa-user-shield"></i> Demander à devenir manager
                        </a>
                    {% endif %}
                    {% if canJoinTeam %}
                        <button type="button" class="admin-tournament-btn ghost" onclick="openJoinTeamModal()">
                            <i class="fas fa-users"></i> Rejoindre une équipe
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <div class="admin-tournament-hero-glow"></div>
    </section>

    <section class="team-shell">
        <div class="admin-tournament-tabs team-tabs" id="team-tabs">
            <button type="button" class="tab active" data-game="">Tous</button>
            <button type="button" class="tab" data-game="fps">FPS</button>
            <button type="button" class="tab" data-game="moba">MOBA</button>
            <button type="button" class="tab" data-game="sports">Sports</button>
            <button type="button" class="tab" data-game="battle">Battle Royale</button>
        </div>

        <div class="admin-tournament-panel team-search-panel">
            <div class="admin-tournament-panel-title">
                <i class="fas fa-search"></i> Recherche avancée
            </div>
            <div class="admin-tournament-form team-filter-grid">
                <div class="field">
                    <label><i class="fas fa-font"></i> Nom</label>
                    <input type="text" id="team-filter-name" placeholder="Nom de l'équipe">
                </div>
                <div class="field">
                    <label><i class="fas fa-gamepad"></i> Jeu</label>
                    <input type="text" id="team-filter-game" placeholder="Ex: Valorant, LoL...">
                </div>
                <div class="field">
                    <label><i class="fas fa-medal"></i> Niveau</label>
                    <select id="team-filter-rank">
                        <option value="">Tous</option>
                        <option value="bronze">Bronze</option>
                        <option value="argent">Argent</option>
                        <option value="or">Or</option>
                        <option value="platine">Platine</option>
                        <option value="diamant">Diamant</option>
                        <option value="master">Master</option>
                        <option value="challenger">Challenger</option>
                    </select>
                </div>
                <div class="field">
                    <label><i class="fas fa-user-check"></i> Recrutement</label>
                    <select id="team-filter-recruitment">
                        <option value="">Tous</option>
                        <option value="open">Ouvert</option>
                        <option value="closed">Fermé</option>
                    </select>
                </div>
            </div>
            <div class="admin-tournament-actions">
                <button type="button" class="admin-tournament-btn" id="team-filter-apply">
                    <i class="fas fa-filter"></i> Rechercher
                </button>
                <button type="button" class="admin-tournament-btn ghost" id="team-filter-reset">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </button>
            </div>
        </div>

        <div class="team-grid" id="team-grid">
            {% for team in featuredTeams %}
                {% set recruitmentStatus = team.recrutements|length > 0 ? 'open' : 'closed' %}
                <article class="team-card" data-name="{{ team.nomEquipe|lower }}" data-rank="{{ team.classement|lower }}" data-game="{{ (team.description|default('') ~ ' ' ~ (team.tag|default('')) ~ ' ' ~ (team.region|default(''))) | lower }}" data-recruit="{{ recruitmentStatus }}">
                    <div class="team-logo-wrap">
                        <img src="{{ team.logo ? asset('uploads/equipes/' ~ team.logo) : asset('images/logo3.png') }}" alt="{{ team.nomEquipe }}">
                    </div>
                    <div class="team-card-body">
                        <h3 class="team-card-title">{{ team.nomEquipe }}</h3>
                        <div class="team-badges">
                            <span class="badge badge-info"><i class="fas fa-medal"></i> {{ team.classement|upper }}</span>
                            {% if recruitmentStatus == 'open' %}
                                <span class="badge badge-success">Recrutement ouvert</span>
                            {% else %}
                                <span class="badge badge-muted">Recrutement fermé</span>
                            {% endif %}
                        </div>
                        <p class="team-card-desc team-description">{{ team.description ? team.description|slice(0, 120) ~ '...' : 'Aucune description pour le moment.' }}</p>
                        <div class="team-card-actions">
                            <a href="{{ path('app_equipes_show', {'id': team.id}) }}" class="btn-gradient">Voir le profil</a>
                        </div>
                    </div>
                </article>
            {% else %}
                <div class="team-empty">
                    <i class="fas fa-ghost"></i>
                    <h3>Aucune équipe trouvée</h3>
                    <p>Revenez plus tard ou ajustez vos filtres.</p>
                </div>
            {% endfor %}
        </div>
    </section>

    {% if canJoinTeam %}
    <div id="join-team-modal" class="team-join-modal" style="display: none;">
        <div class="team-join-modal-card">
            <button onclick="closeJoinTeamModal()" class="team-join-close">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="team-join-title"><i class="fas fa-sign-in-alt"></i> Rejoindre une équipe</h2>
            <p class="team-join-subtitle">Recherchez une équipe et postulez directement.</p>

            <div class="team-join-search">
                <input type="text" id="team-search" placeholder="Rechercher une équipe...">
                <button class="admin-tournament-btn" onclick="searchTeams()"><i class="fas fa-search"></i> Rechercher</button>
            </div>

            <div id="available-teams" class="team-join-list">
                {% for team in featuredTeams %}
                <div class="team-join-item">
                    <img src="{{ team.logo ? asset('uploads/equipes/' ~ team.logo) : asset('images/logo3.png') }}" alt="{{ team.nomEquipe }}">
                    <div class="team-join-info">
                        <h4>{{ team.nomEquipe }}</h4>
                        <span class="badge badge-info"><i class="fas fa-medal"></i> {{ team.classement }}</span>
                    </div>
                    <div class="team-join-actions">
                        <button class="admin-tournament-btn" onclick="applyToTeam({{ team.id }}, '{{ team.nomEquipe|e('js') }}')">
                            <i class="fas fa-paper-plane"></i> Postuler
                        </button>
                        <a class="admin-tournament-btn ghost" href="{{ path('app_equipes_show', {'id': team.id}) }}">Profil</a>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div id="no-teams-found" class="team-join-empty" style="display: none;">
                <i class="fas fa-search"></i>
                <p>Aucune équipe trouvée</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    function openJoinTeamModal() {
        const modal = document.getElementById('join-team-modal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function closeJoinTeamModal() {
        const modal = document.getElementById('join-team-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('team-grid');
        const nameInput = document.getElementById('team-filter-name');
        const gameInput = document.getElementById('team-filter-game');
        const rankSelect = document.getElementById('team-filter-rank');
        const recruitSelect = document.getElementById('team-filter-recruitment');
        const applyBtn = document.getElementById('team-filter-apply');
        const resetBtn = document.getElementById('team-filter-reset');
        const tabs = document.querySelectorAll('#team-tabs .tab');

        if (!grid) return;

        const applyFilters = () => {
            const nameValue = (nameInput?.value || '').toLowerCase().trim();
            const gameValue = (gameInput?.value || '').toLowerCase().trim();
            const rankValue = (rankSelect?.value || '').toLowerCase();
            const recruitValue = (recruitSelect?.value || '').toLowerCase();

            let visible = 0;
            grid.querySelectorAll('.team-card').forEach(card => {
                const name = card.dataset.name || '';
                const game = card.dataset.game || '';
                const rank = card.dataset.rank || '';
                const recruit = card.dataset.recruit || '';

                let match = true;
                if (nameValue && !name.includes(nameValue)) match = false;
                if (gameValue && !game.includes(gameValue)) match = false;
                if (rankValue && rankValue !== rank) match = false;
                if (recruitValue && recruitValue !== recruit) match = false;

                card.style.display = match ? '' : 'none';
                if (match) visible++;
            });
        };

        applyBtn?.addEventListener('click', applyFilters);
        resetBtn?.addEventListener('click', () => {
            if (nameInput) nameInput.value = '';
            if (gameInput) gameInput.value = '';
            if (rankSelect) rankSelect.value = '';
            if (recruitSelect) recruitSelect.value = '';
            tabs.forEach(tab => tab.classList.remove('active'));
            if (tabs[0]) tabs[0].classList.add('active');
            applyFilters();
        });

        [nameInput, gameInput, rankSelect, recruitSelect].forEach(el => {
            if (!el) return;
            el.addEventListener('input', applyFilters);
            el.addEventListener('change', applyFilters);
        });

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                if (gameInput) gameInput.value = tab.dataset.game || '';
                applyFilters();
            });
        });
    });

    async function searchTeams() {
        const input = document.getElementById('team-search');
        const list = document.getElementById('available-teams');
        const emptyState = document.getElementById('no-teams-found');
        if (!list) return;

        const query = (input?.value || '').trim();
        if (!query) {
            list.style.display = '';
            if (emptyState) emptyState.style.display = 'none';
            return;
        }

        try {
            const response = await fetch('{{ path('app_equipes_api_search') }}?q=' + encodeURIComponent(query));
            const data = await response.json();
            list.innerHTML = '';

            if (!Array.isArray(data) || data.length === 0) {
                list.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            data.forEach(team => {
                const item = document.createElement('div');
                item.className = 'team-join-item';
                const logoSrc = team.logo ? `{{ asset('uploads/equipes/') }}${team.logo}` : `{{ asset('images/logo3.png') }}`;
                item.innerHTML = `
                    <img src="${logoSrc}" alt="${team.name}">
                    <div class="team-join-info">
                        <h4>${team.name}</h4>
                        <span class="badge badge-info"><i class="fas fa-medal"></i> ${team.rank}</span>
                    </div>
                    <div class="team-join-actions">
                        <button class="admin-tournament-btn" onclick="applyToTeam(${team.id})">
                            <i class="fas fa-paper-plane"></i> Postuler
                        </button>
                        <a class="admin-tournament-btn ghost" href="/equipe/${team.id}">Profil</a>
                    </div>
                `;
                list.appendChild(item);
            });

            list.style.display = '';
            if (emptyState) emptyState.style.display = 'none';
        } catch (e) {
            list.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
        }
    }

    function applyToTeam(teamId) {
        if (!teamId) return;
        window.location.href = `/equipe/${teamId}/postuler`;
    }
</script>
{% endblock %}
