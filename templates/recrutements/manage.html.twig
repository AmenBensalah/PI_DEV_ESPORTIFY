{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/recrutements.css') }}">
{% endblock %}

{% block body_class %}page-recrutements-manage{% endblock %}

{% block title %}Gestion des Demandes - E-Sportify{% endblock %}

{% block body %}
    <div id="recruitment-container">
        <!-- Page Header -->
        <div class="page-header animate__animated animate__fadeInDown">
            <h1 class="hero-title recrutements-title">
                <i class="fas fa-user-plus"></i> GESTION DES CANDIDATURES
            </h1>
            <p class="hero-subtitle recrutements-subtitle">
                Candidatures pour l'équipe <span class="team-name">{{ equipe.nomEquipe }}</span>
            </p>
            <div class="page-header-actions">
                {% if aiEnabled %}
                    <a href="{{ path('app_recrutements_manage', {'id': equipe.id, 'ai': useAi ? 0 : 1}) }}" class="btn-outline">
                        <i class="fas fa-brain"></i>
                        {% if useAi %}Désactiver IA{% else %}Activer IA{% endif %}
                    </a>
                {% else %}
                    <span class="badge badge-danger">IA désactivée (clé manquante)</span>
                {% endif %}
                <span class="badge badge-info">Tri par score local</span>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs" role="tablist" aria-label="Filtres des demandes">
            <button class="filter-tab active" onclick="filterRequests('all')">
                Toutes (<span>{{ candidatures|length }}</span>)
            </button>
            <button class="filter-tab" onclick="filterRequests('pending')">
                En attente (<span>{{ pendingCount }}</span>)
            </button>
            <button class="filter-tab" onclick="filterRequests('accepted')">
                Acceptées (<span>{{ acceptedCount }}</span>)
            </button>
            <button class="filter-tab" onclick="filterRequests('refused')">
                Refusées (<span>{{ refusedCount }}</span>)
            </button>
        </div>

        <!-- Recruitment Requests List -->
        <div id="requests-list" class="requests-list" data-recruitment-filter-target="list">
            {% for candidature in candidatures %}
            <div class="card recruitment-card animate__animated animate__fadeInUp" role="article" aria-label="Candidature de {{ candidature.user.pseudo }}" 
                 data-status="{% if candidature.statut == 'En attente' %}pending{% elseif candidature.statut == 'Accepté' %}accepted{% else %}refused{% endif %}"
                 style="animation-delay: {{ loop.index0 * 0.05 }}s; {% if candidature.statut == 'Accepté' %}border-color: var(--success-color);{% elseif candidature.statut == 'Refusé' %}border-color: var(--primary-pink);{% endif %}">
                <div style="display: flex; gap: 20px; align-items: start;">
                    <!-- Avatar -->
                    <div style="flex-shrink: 0;">
                        <div class="avatar" style="background:var(--gradient-1); font-size:24px;">{{ candidature.user.pseudo|slice(0, 2)|upper }}</div>
                    </div>
                    
                    <!-- Content -->
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <h3 style="font-size: 24px; margin-bottom: 8px; font-family: 'Orbitron', sans-serif;">
                                    {{ candidature.user.pseudo }} <span style="font-size: 14px; opacity: 0.7;">({{ candidature.user.nom }})</span>
                                </h3>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <span class="badge {% if candidature.statut == 'En attente' %}badge-warning{% elseif candidature.statut == 'Accepté' %}badge-success{% else %}badge-danger{% endif %}" style="{% if candidature.statut == 'En attente' %}background: var(--warning-color);{% endif %}">
                                        {% if candidature.statut == 'En attente' %}
                                            <i class="fas fa-clock"></i> EN ATTENTE
                                        {% elseif candidature.statut == 'Accepté' %}
                                            <i class="fas fa-check-circle"></i> ACCEPTÉE
                                        {% else %}
                                            <i class="fas fa-times-circle"></i> REFUSÉE
                                        {% endif %}
                                    </span>
                                    <span class="badge badge-primary">
                                        <i class="fas fa-gamepad"></i> {{ candidature.niveau }}
                                    </span>
                                    {% set score = localScores[candidature.id].score|default(0) %}
                                    <span class="badge badge-info">
                                        <i class="fas fa-chart-line"></i> Score local {{ score }}
                                    </span>
                                    <span class="badge" style="background: rgba(0, 217, 255, 0.1); color: var(--primary-blue); border: 1px solid var(--primary-blue);">
                                        <i class="fas fa-envelope"></i> {{ candidature.user.email }}
                                    </span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: var(--text-secondary); font-size: 14px; display: block;">
                                    <i class="fas fa-calendar"></i> {{ candidature.dateCandidature|date('d/m/Y') }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Details Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- Motivation (Short) -->
                            <div style="background: var(--darker-bg); padding: 15px; border-radius: 12px;">
                                <h4 style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px;">
                                    <i class="fas fa-comment"></i> Présentation
                                </h4>
                                <p style="color: var(--text-primary); font-size: 14px; line-height: 1.6;">
                                    {{ candidature.motivation }}
                                </p>
                            </div>
                            
                            <!-- Style de jeu -->
                            <div style="background: var(--darker-bg); padding: 15px; border-radius: 12px;">
                                <h4 style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px;">
                                    <i class="fas fa-crosshairs"></i> Style de Jeu
                                </h4>
                                <p style="color: var(--text-primary); font-size: 14px; line-height: 1.6;">
                                    {{ candidature.playStyle ?? 'Non spécifié' }}
                                </p>
                            </div>
                        </div>

                        <!-- IA + Raisons (Local) -->
                        <div class="ai-insights-grid">
                            <div class="ai-card local">
                                <h4 class="ai-card-title"><i class="fas fa-list-check"></i> Raisons (local)</h4>
                                <p class="ai-card-text">
                                    {{ localScores[candidature.id].reasons|default([])|join(', ') }}
                                </p>
                            </div>
                            <div class="ai-card ai">
                                <h4 class="ai-card-title"><i class="fas fa-brain"></i> Résumé IA</h4>
                                {% set insight = aiInsights[candidature.id]|default(null) %}
                                {% if insight %}
                                    <p class="ai-card-text">{{ insight.summary }}</p>
                                    <div class="ai-flags">
                                        <span class="badge badge-info">Reco: {{ insight.recommendation|upper }}</span>
                                        {% for flag in insight.flags %}
                                            <span class="badge badge-danger">{{ flag }}</span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="ai-card-text muted">
                                        {% if useAi %}Analyse IA indisponible.{% else %}IA désactivée.{% endif %}
                                    </p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Raison (Long) -->
                        <div style="background: var(--darker-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h4 style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px;">
                                <i class="fas fa-question-circle"></i> Pourquoi cette équipe ?
                            </h4>
                            <p style="color: var(--text-primary); line-height: 1.8; font-size: 15px;">
                                {{ candidature.reason ?? 'Candidature simplifiée' }}
                            </p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="card-actions">
                            {% if candidature.statut == 'En attente' %}
                                <form method="post" action="{{ path('app_recrutements_accept', {'id': candidature.id}) }}" class="inline-form">
                                    <button type="submit" class="btn-gradient" onclick="return confirm('✅ Accepter {{ candidature.user.pseudo }} ?')">
                                        <i class="fas fa-check"></i> Accepter
                                    </button>
                                </form>
                                <form method="post" action="{{ path('app_recrutements_refuse', {'id': candidature.id}) }}" class="inline-form">
                                    <button type="submit" class="btn-danger" onclick="return confirm('❌ Refuser {{ candidature.user.pseudo }} ?')">
                                        <i class="fas fa-times"></i> Refuser
                                    </button>
                                </form>
                            {% else %}
                                <button disabled class="btn-outline">
                                    <i class="fas fa-lock"></i> Traitée
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="empty-state" style="text-align: center; padding: 60px 20px;">
                <div class="empty-icon" style="width: 100px; height: 100px; margin: 0 auto 20px; border-radius: 50%; background: rgba(0, 217, 255, 0.1); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-inbox" style="font-size: 48px; color: var(--primary-blue);"></i>
                </div>
                <h3 class="empty-title" style="font-family: 'Orbitron', sans-serif; font-size: 24px; margin-bottom: 10px;">Aucune Candidature</h3>
                <p class="empty-text" style="color: var(--text-secondary);">
                    Votre équipe n'a pas encore reçu de candidature.
                </p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <script>
        function filterRequests(filter) {
            const cards = document.querySelectorAll('.recruitment-card');
            const tabs = document.querySelectorAll('.filter-tab');
            
            // Update active tab logic here (reusing existing script if present or adding new simple logic)
            tabs.forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            cards.forEach(card => {
                if (filter === 'all' || card.dataset.status === filter) {
                    card.style.display = 'block';
                    card.classList.add('animate__fadeInUp');
                } else {
                    card.style.display = 'none';
                    card.classList.remove('animate__fadeInUp');
                }
            });
        }
    </script>
{% endblock %}
