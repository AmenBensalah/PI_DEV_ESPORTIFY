{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des Produits - Admin{% endblock %}
{% block page_title %}Gestion des Produits{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Gestion des Produits</h2>
        <p class="admin-tournament-lead">Gérez le catalogue, les stocks et les prix de la boutique.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('admin_boutique_produit_new') }}" class="admin-tournament-btn">
                <i class="fas fa-plus"></i> Créer un produit
            </a>
            <a href="{{ path('admin_boutique_produit_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="#" data-cat="" class="tab js-filter-cat active">Tous</a>
        {% for cat in categories %}
            <a href="#" data-cat="{{ cat.id }}" class="tab js-filter-cat">{{ cat.nom }}</a>
        {% endfor %}
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form id="admin-product-filter-form" class="admin-tournament-form" onsubmit="return false;">
            <input type="hidden" name="ajax" value="1">
            <input type="hidden" name="categorie" id="filter-categorie" value="{{ currentCat }}">
            <input type="hidden" name="sort" id="filter-sort" value="{{ currentSort }}">
            
            <div class="field">
                <label>Produit</label>
                <input type="text" name="q" id="filter-q" placeholder="Nom du produit..." value="{{ currentSearch }}">
            </div>
            <div class="field">
                <label>Prix min</label>
                <input type="number" name="minPrice" id="filter-min" placeholder="0" value="{{ minPrice }}">
            </div>
            <div class="field">
                <label>Prix max</label>
                <input type="number" name="maxPrice" id="filter-max" placeholder="999" value="{{ maxPrice }}">
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="statut" id="filter-statut">
                    <option value="">-- Tous --</option>
                    <option value="1" {% if currentStatut == '1' %}selected{% endif %}>Disponible</option>
                    <option value="0" {% if currentStatut == '0' %}selected{% endif %}>Rupture</option>
                </select>
            </div>
            <div class="admin-tournament-actions">
                <button type="button" id="btn-search" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <button type="button" id="btn-reset" class="admin-tournament-btn ghost">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </button>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="#" class="js-sort" data-sort="prix_asc">Prix ↑</a>
            <a href="#" class="js-sort" data-sort="prix_desc">Prix ↓</a>
            <a href="#" class="js-sort" data-sort="stock">Stock</a>
            <a href="#" class="js-sort" data-sort="">Date</a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="admin-tournament-alert success">
            <i class="fas fa-check-circle"></i> {{ message }}
        </div>
    {% endfor %}

    <div id="product-table-container" class="admin-tournament-table">
        {% include 'admin/boutique/produit/_table.html.twig' %}
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('admin-product-filter-form');
        const container = document.getElementById('product-table-container');
        const catInput = document.getElementById('filter-categorie');
        const sortInput = document.getElementById('filter-sort');
        
        let debounceTimer;

        const fetchResults = () => {
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);
            
            // Show loading state
            container.style.opacity = '0.5';
            
            fetch(`${window.location.pathname}?${params.toString()}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
                container.style.opacity = '1';
                
                // Update URL without reload
                const newUrl = `${window.location.pathname}?${params.toString()}`;
                window.history.pushState({path: newUrl}, '', newUrl);
            })
            .catch(err => {
                console.error('Error:', err);
                container.style.opacity = '1';
            });
        };

        // Live search on inputs
        ['filter-q', 'filter-min', 'filter-max'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(fetchResults, 400);
                });
            }
        });

        // Immediate search on select
        document.getElementById('filter-statut').addEventListener('change', fetchResults);
        
        // Buttons
        document.getElementById('btn-search').addEventListener('click', fetchResults);
        document.getElementById('btn-reset').addEventListener('click', () => {
            form.reset();
            catInput.value = '';
            sortInput.value = '';
            // Update tabs active state
            document.querySelectorAll('.js-filter-cat').forEach(t => t.classList.remove('active'));
            document.querySelector('.js-filter-cat[data-cat=""]').classList.add('active');
            fetchResults();
        });

        // Category Tabs
        document.querySelectorAll('.js-filter-cat').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.js-filter-cat').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                catInput.value = tab.dataset.cat;
                fetchResults();
            });
        });

        // Sorting
        document.querySelectorAll('.js-sort').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                sortInput.value = link.dataset.sort;
                fetchResults();
            });
        });
    });
</script>
{% endblock %}
