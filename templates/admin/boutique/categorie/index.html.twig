{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des Catégories - Admin{% endblock %}
{% block page_title %}Gestion des Catégories{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Gestion des Catégories</h2>
        <p class="admin-tournament-lead">Organisez vos produits par catégories.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('admin_boutique_categorie_new') }}" class="admin-tournament-btn">
                <i class="fas fa-plus"></i> Créer une catégorie
            </a>
            <a href="{{ path('admin_boutique_categorie_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="#" class="tab active" data-filter="all">Toutes</a>
        <a href="#" class="tab" data-filter="empty">Sans produits</a>
        <a href="#" class="tab" data-filter="filled">Avec produits</a>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form class="admin-tournament-form" data-filter-form>
            <div class="field">
                <label>Nom de catégorie</label>
                <input type="text" name="q" placeholder="Rechercher...">
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="status">
                    <option value="">-- Tous --</option>
                    <option value="empty">Sans produits</option>
                    <option value="filled">Avec produits</option>
                </select>
            </div>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <button type="reset" class="admin-tournament-btn ghost">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </button>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="#" data-sort="name:asc">Nom A→Z</a>
            <a href="#" data-sort="name:desc">Nom Z→A</a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="admin-tournament-alert success">
            <i class="fas fa-check-circle"></i> {{ message }}
        </div>
    {% endfor %}

    {% if categories %}
        <div class="admin-tournament-table">
            <table data-table="categories">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Produits</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in categories %}
                        {% set productCount = c.produits is defined ? c.produits|length : 0 %}
                        <tr class="admin-tournament-row"
                            data-name="{{ c.nom|lower }}"
                            data-count="{{ productCount }}">
                            <td>#{{ c.id }}</td>
                            <td class="name">{{ c.nom }}</td>
                            <td>
                                {% if productCount > 0 %}
                                    <span class="badge badge-success">{{ productCount }} produit(s)</span>
                                {% else %}
                                    <span class="badge badge-muted">Vide</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="admin-tournament-row-actions">
                                    <a href="{{ path('admin_boutique_produit_index', {categorie: c.id}) }}" class="admin-tournament-icon" title="Voir">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ path('admin_boutique_categorie_edit', {id: c.id}) }}" class="admin-tournament-icon cyan" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form method="post" action="{{ path('admin_boutique_categorie_delete', {id: c.id}) }}" onsubmit="return confirm('Supprimer cette catégorie ?');">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ c.id) }}">
                                        <button type="submit" class="admin-tournament-icon danger" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="admin-tournament-empty">
            <div class="empty-ring"></div>
            <strong>Aucune catégorie trouvée</strong>
            <p>Créez une première catégorie pour classer vos produits.</p>
        </div>
    {% endif %}
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('[data-filter-form]');
        const tabs = document.querySelectorAll('.admin-tournament-tabs .tab');
        const rows = Array.from(document.querySelectorAll('[data-table=\"categories\"] tbody tr'));
        const sortLinks = document.querySelectorAll('.admin-tournament-sort a[data-sort]');

        const applyFilters = () => {
            const formData = new FormData(form);
            const query = (formData.get('q') || '').toLowerCase();
            const status = (formData.get('status') || '').toLowerCase();

            rows.forEach(row => {
                const name = row.dataset.name || '';
                const count = parseInt(row.dataset.count || '0', 10);
                const matchesName = !query || name.includes(query);
                const matchesStatus = !status ||
                    (status === 'empty' && count === 0) ||
                    (status === 'filled' && count > 0);

                row.style.display = matchesName && matchesStatus ? '' : 'none';
            });
        };

        const applySort = (field, direction) => {
            const tbody = rows[0] ? rows[0].closest('tbody') : null;
            if (!tbody) {
                return;
            }
            const sorted = rows.slice().sort((a, b) => {
                const aVal = a.dataset.name || '';
                const bVal = b.dataset.name || '';
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });
            sorted.forEach(row => tbody.appendChild(row));
        };

        if (form) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                applyFilters();
            });
            form.addEventListener('reset', () => {
                setTimeout(() => {
                    tabs.forEach(tab => tab.classList.remove('active'));
                    if (tabs[0]) {
                        tabs[0].classList.add('active');
                    }
                    applyFilters();
                }, 0);
            });
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', (event) => {
                event.preventDefault();
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                if (form) {
                    form.querySelector('select[name=\"status\"]').value = tab.dataset.filter === 'empty' ? 'empty' : tab.dataset.filter === 'filled' ? 'filled' : '';
                    applyFilters();
                }
            });
        });

        sortLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const [field, direction] = (link.dataset.sort || '').split(':');
                applySort(field, direction);
            });
        });
    });
</script>
{% endblock %}
