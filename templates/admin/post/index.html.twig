{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des Publications - Admin{% endblock %}
{% block page_title %}Gestion des Publications{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Fil d'actualité</div>
        <h2 class="admin-tournament-title">Gestion des Publications</h2>
        <p class="admin-tournament-lead">Modérez et mettez en avant les publications.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('fil_admin_post_new') }}" class="admin-tournament-btn">
                <i class="fas fa-plus"></i> Créer une publication
            </a>
            <a href="{{ path('fil_admin_post_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="{{ path('fil_admin_post_index') }}" class="tab active">Publications</a>
        <a href="{{ path('fil_admin_announcement_index') }}" class="tab">Annonces</a>
        <a href="{{ path('fil_admin_comment_index') }}" class="tab">Commentaires</a>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form class="admin-tournament-form" data-filter-form>
            <div class="field">
                <label>Contenu</label>
                <input type="text" name="q" placeholder="Rechercher...">
            </div>
            <div class="field">
                <label>Type</label>
                <select name="media">
                    <option value="">-- Tous --</option>
                    <option value="event">Événement</option>
                    <option value="post">Publication</option>
                </select>
            </div>
            <div class="field">
                <label>Date (du)</label>
                <input type="date" name="date_from">
            </div>
            <div class="field">
                <label>Date (au)</label>
                <input type="date" name="date_to">
            </div>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <button type="reset" class="admin-tournament-btn ghost">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </button>
            </div>
        </form>

            <div class="admin-tournament-sort">
                <span>Trier :</span>
                <a href="#" data-sort="date:desc">Date ↓</a>
                <a href="#" data-sort="date:asc">Date ↑</a>
                <a href="#" data-sort="type:asc">Type A→Z</a>
                <a href="#" data-sort="type:desc">Type Z→A</a>
            </div>
    </div>

    {% if posts %}
        <div class="admin-tournament-table">
            <table data-table="posts">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Contenu</th>
                        <th>Média</th>
                        <th>Création</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for post in posts %}
                        {% set mediaType = post.isEvent ? 'event' : 'post' %}
                        <tr class="admin-tournament-row"
                            data-type="{{ mediaType|lower }}"
                            data-date="{{ post.createdAt ? post.createdAt|date('Y-m-d') : '' }}"
                            data-search="{{ post.id }} {{ mediaType }} {{ post.content|default('') }} {{ post.imagePath|default('') }} {{ post.videoUrl|default('') }}">
                            <td>#{{ post.id }}</td>
                            <td><span class="badge badge-info">{{ post.isEvent ? 'Événement' : 'Publication' }}</span></td>
                            <td>{{ post.content|default('')|slice(0, 80) }}</td>
                            <td>
                                {% if post.imagePath %}
                                    {{ post.imagePath|slice(0, 40) }}
                                {% elseif post.videoUrl %}
                                    {{ post.videoUrl|slice(0, 40) }}
                                {% endif %}
                            </td>
                            <td>{{ post.createdAt ? post.createdAt|date('d/m/Y H:i') : '' }}</td>
                            <td>
                                <div class="admin-tournament-row-actions">
                                    <a class="admin-tournament-icon" href="{{ path('fil_admin_post_edit', {id: post.id}) }}" title="Voir">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a class="admin-tournament-icon cyan" href="{{ path('fil_admin_post_edit', {id: post.id}) }}" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form method="post" action="{{ path('fil_admin_post_delete', {id: post.id}) }}" onsubmit="return confirm('Supprimer cette publication ?');">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete_post_' ~ post.id) }}">
                                        <button class="admin-tournament-icon danger" type="submit" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="admin-tournament-empty">
            <div class="empty-ring"></div>
            <strong>Aucune publication</strong>
            <p>Créez votre première publication.</p>
        </div>
    {% endif %}
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('[data-filter-form]');
        const rows = Array.from(document.querySelectorAll('[data-table=\"posts\"] tbody tr'));
        const sortLinks = document.querySelectorAll('.admin-tournament-sort a[data-sort]');

        const applyFilters = () => {
            const formData = new FormData(form);
            const query = (formData.get('q') || '').toLowerCase();
            const media = (formData.get('media') || '').toLowerCase();
            const from = formData.get('date_from');
            const to = formData.get('date_to');

            rows.forEach(row => {
                const search = (row.dataset.search || '').toLowerCase();
                const type = (row.dataset.type || '').toLowerCase();
                const date = row.dataset.date || '';
                const matchesQuery = !query || search.includes(query);
                const matchesType = !media || type === media;
                const matchesFrom = !from || (date && date >= from);
                const matchesTo = !to || (date && date <= to);
                row.style.display = matchesQuery && matchesType && matchesFrom && matchesTo ? '' : 'none';
            });
        };

        const applySort = (field, direction) => {
            const tbody = rows[0] ? rows[0].closest('tbody') : null;
            if (!tbody) {
                return;
            }
            const sorted = rows.slice().sort((a, b) => {
                if (field === 'date') {
                    const aVal = a.dataset.date || '';
                    const bVal = b.dataset.date || '';
                    return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                if (field === 'type') {
                    const aVal = a.dataset.type || '';
                    const bVal = b.dataset.type || '';
                    return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return 0;
            });
            sorted.forEach(row => tbody.appendChild(row));
        };

        if (form) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                applyFilters();
            });
            form.addEventListener('reset', () => {
                setTimeout(applyFilters, 0);
            });
        }

        sortLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const [field, direction] = (link.dataset.sort || '').split(':');
                applySort(field, direction);
            });
        });
    });
</script>
{% endblock %}
