{% extends 'admin/layout.html.twig' %}

{% block title %}Gestion des Tournois - Admin{% endblock %}
{% block page_title %}Gestion des Tournois{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Gestion des Tournois</h2>
        <p class="admin-tournament-lead">Pilote les tournois, filtre, trie et gère les actions clés.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('admin_tournoi_create') }}" class="admin-tournament-btn">
                <i class="fas fa-plus"></i> Créer un tournoi
            </a>
            <a href="{{ path('admin_tournoi_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="{{ path('admin_tournoi_index') }}" class="tab {{ app.request.attributes.get('_route') == 'admin_tournoi_index' ? 'active' : '' }}">Tous</a>
        <a href="{{ path('admin_tournoi_by_category', {typeGame: 'FPS'}) }}" class="tab {{ app.request.attributes.get('_route') == 'admin_tournoi_by_category' and app.request.get('typeGame') == 'FPS' ? 'active' : '' }}">FPS</a>
        <a href="{{ path('admin_tournoi_by_category', {typeGame: 'Sports'}) }}" class="tab {{ app.request.attributes.get('_route') == 'admin_tournoi_by_category' and app.request.get('typeGame') == 'Sports' ? 'active' : '' }}">Sports</a>
        <a href="{{ path('admin_tournoi_by_category', {typeGame: 'Battle_royale'}) }}" class="tab {{ app.request.attributes.get('_route') == 'admin_tournoi_by_category' and app.request.get('typeGame') == 'Battle_royale' ? 'active' : '' }}">Battle Royale</a>
        <a href="{{ path('admin_tournoi_by_category', {typeGame: 'Mind'}) }}" class="tab {{ app.request.attributes.get('_route') == 'admin_tournoi_by_category' and app.request.get('typeGame') == 'Mind' ? 'active' : '' }}">Mind</a>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form method="GET" class="admin-tournament-form" data-ajax-search-form>
            <div class="field">
                <label>Nom du jeu</label>
                <input type="text" name="game" placeholder="ex: Valorant, Chess..." value="{{ filterGame }}" data-ajax-search-input>
            </div>
            <div class="field">
                <label>Type de jeu</label>
                <select name="type_game">
                    <option value="">-- Tous --</option>
                    <option value="FPS" {% if filterTypeGame == 'FPS' %}selected{% endif %}>FPS</option>
                    <option value="Sports" {% if filterTypeGame == 'Sports' %}selected{% endif %}>Sports</option>
                    <option value="Battle_royale" {% if filterTypeGame == 'Battle_royale' %}selected{% endif %}>Battle Royale</option>
                    <option value="Mind" {% if filterTypeGame == 'Mind' %}selected{% endif %}>Mind</option>
                </select>
            </div>
            <div class="field">
                <label>Type de tournoi</label>
                <select name="type_tournoi">
                    <option value="">-- Tous --</option>
                    <option value="solo" {% if filterTypeTournoi == 'solo' %}selected{% endif %}>Solo</option>
                    <option value="squad" {% if filterTypeTournoi == 'squad' %}selected{% endif %}>Squad</option>
                </select>
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="status">
                    <option value="">-- Tous --</option>
                    <option value="planned" {% if filterStatus == 'planned' %}selected{% endif %}>Planifié</option>
                    <option value="ongoing" {% if filterStatus == 'ongoing' %}selected{% endif %}>En cours</option>
                    <option value="finished" {% if filterStatus == 'finished' %}selected{% endif %}>Terminé</option>
                </select>
            </div>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <a href="{{ path('admin_tournoi_index') }}" class="admin-tournament-btn ghost">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </a>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="{{ path('admin_tournoi_index', app.request.query.all | merge({'sort':'name','order':'asc'})) }}">Nom A→Z</a>
            <a href="{{ path('admin_tournoi_index', app.request.query.all | merge({'sort':'name','order':'desc'})) }}">Nom Z→A</a>
            <a href="{{ path('admin_tournoi_index', app.request.query.all | merge({'sort':'startDate','order':'asc'})) }}">Date ↑</a>
            <a href="{{ path('admin_tournoi_index', app.request.query.all | merge({'sort':'startDate','order':'desc'})) }}">Date ↓</a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="admin-tournament-alert success">
            <i class="fas fa-check-circle"></i> {{ message }}
        </div>
    {% endfor %}

        <div class="admin-tournament-table" data-ajax-search-table {% if not tournois %}style="display:none;"{% endif %}>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Type jeu</th>
                        <th>Type tournoi</th>
                        <th>Jeu</th>
                        <th>Statut</th>
                        <th>Début</th>
                        <th>Fin</th>
                        <th>Places restantes</th>
                        <th>Prix</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody data-ajax-search-rows>
                    {% include 'admin/tournoi/_table_rows.html.twig' with { tournois: tournois } %}
                </tbody>
            </table>
        </div>
        <div class="admin-tournament-empty" data-ajax-search-empty {% if tournois %}style="display:none;"{% endif %}>
            <div class="empty-ring"></div>
            <strong>Aucun tournoi trouvé</strong>
            <p>Commence par créer un nouveau tournoi.</p>
            <a href="{{ path('admin_tournoi_create') }}" class="admin-tournament-btn">
                <i class="fas fa-plus"></i> Créer le premier tournoi
            </a>
        </div>
</section>
{% endblock %}

{% block javascripts %}
<script>
(() => {
    const form = document.querySelector('[data-ajax-search-form]');
    if (!form) {
        return;
    }

    const searchInput = form.querySelector('[data-ajax-search-input]');
    const rowsContainer = document.querySelector('[data-ajax-search-rows]');
    const tableContainer = document.querySelector('[data-ajax-search-table]');
    const emptyState = document.querySelector('[data-ajax-search-empty]');
    if (!searchInput || !rowsContainer || !tableContainer || !emptyState) {
        return;
    }

    const endpoint = '{{ path('admin_tournoi_search') }}';
    const currentSort = '{{ currentSort|default('') }}';
    const currentOrder = '{{ currentOrder|default('ASC') }}';
    let debounceTimer = null;
    let currentController = null;

    const updateVisibility = (count) => {
        if (count > 0) {
            tableContainer.style.display = '';
            emptyState.style.display = 'none';
            return;
        }
        tableContainer.style.display = 'none';
        emptyState.style.display = '';
    };

    const runSearch = () => {
        const params = new URLSearchParams(new FormData(form));
        if (currentSort) {
            params.set('sort', currentSort);
        }
        if (currentOrder) {
            params.set('order', currentOrder);
        }

        if (currentController) {
            currentController.abort();
        }
        currentController = new AbortController();

        fetch(`${endpoint}?${params.toString()}`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            signal: currentController.signal
        })
            .then((response) => response.ok ? response.json() : Promise.reject(new Error('HTTP ' + response.status)))
            .then((data) => {
                rowsContainer.innerHTML = data.rows || '';
                updateVisibility(Number(data.count || 0));
            })
            .catch((error) => {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Recherche AJAX échouée:', error);
            });
    };

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        runSearch();
    });

    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(runSearch, 180);
    });

    form.querySelectorAll('select').forEach((field) => {
        field.addEventListener('change', runSearch);
    });
})();
</script>
{% endblock %}
