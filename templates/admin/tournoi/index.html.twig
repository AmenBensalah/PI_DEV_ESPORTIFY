{% extends 'admin/layout.html.twig' %}

{% block title %}Gestion des Tournois - Admin{% endblock %}
{% block page_title %}Gestion des Tournois{% endblock %}
{% block stylesheets %}
<style>
    .admin-pagination-wrap {
        margin-top: 18px;
        display: flex;
        justify-content: center;
    }

    .admin-pagination {
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px !important;
        padding: 10px 12px !important;
        border-radius: 14px !important;
        border: 1px solid rgba(79, 209, 255, 0.24) !important;
        background: rgba(8, 14, 30, 0.72) !important;
        backdrop-filter: blur(10px);
    }

    .admin-pagination-btn,
    .admin-pagination-page {
        min-width: 36px !important;
        height: 36px !important;
        padding: 0 12px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 10px !important;
        border: 1px solid rgba(255, 255, 255, 0.13) !important;
        background: rgba(255, 255, 255, 0.06) !important;
        color: #dbe7ff !important;
        text-decoration: none !important;
        font-weight: 700 !important;
        line-height: 1 !important;
    }

    .admin-pagination-page.is-active {
        border-color: rgba(56, 189, 248, 0.65) !important;
        background: linear-gradient(135deg, rgba(34, 211, 238, 0.32), rgba(59, 130, 246, 0.34)) !important;
        color: #fff !important;
    }

    .admin-pagination-btn.is-disabled {
        opacity: .35 !important;
        pointer-events: none !important;
    }

    .admin-tournament-chart-panel {
        margin-bottom: 14px;
    }

    .admin-tournament-chart-wrap {
        position: relative;
        min-height: 280px;
    }

    .admin-tournament-chart-wrap canvas {
        width: 100% !important;
        height: 280px !important;
    }

    .admin-tournament-chart-note {
        margin: 10px 0 0;
        color: rgba(223, 238, 255, 0.72);
        font-size: 12px;
    }

    @media (max-width: 768px) {
        .admin-tournament-chart-wrap {
            min-height: 240px;
        }

        .admin-tournament-chart-wrap canvas {
            height: 240px !important;
        }
    }
</style>
{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Gestion des Tournois</h2>
        <p class="admin-tournament-lead">Pilote les tournois, filtre, trie et gère les actions clés.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('admin_tournoi_create') }}" class="admin-tournament-btn">
                <i class="fas fa-plus"></i> Créer un tournoi
            </a>
            <a href="{{ path('admin_tournoi_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
            <a href="{{ path('app_rawg_browser', filterGame ? {'q': filterGame} : {}) }}" target="_blank" rel="noopener noreferrer" class="admin-tournament-btn ghost">
                <i class="fas fa-gamepad"></i> Consulter jeux
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="{{ path('admin_tournoi_index', app.request.query.all|merge({'type_game': ''})) }}" class="tab {{ filterTypeGame|default('') == '' ? 'active' : '' }}" data-type-game="">Tous</a>
        <a href="{{ path('admin_tournoi_index', app.request.query.all|merge({'type_game': 'FPS'})) }}" class="tab {{ filterTypeGame|default('') == 'FPS' ? 'active' : '' }}" data-type-game="FPS">FPS</a>
        <a href="{{ path('admin_tournoi_index', app.request.query.all|merge({'type_game': 'Sports'})) }}" class="tab {{ filterTypeGame|default('') == 'Sports' ? 'active' : '' }}" data-type-game="Sports">Sports</a>
        <a href="{{ path('admin_tournoi_index', app.request.query.all|merge({'type_game': 'Battle_royale'})) }}" class="tab {{ filterTypeGame|default('') == 'Battle_royale' ? 'active' : '' }}" data-type-game="Battle_royale">Battle Royale</a>
        <a href="{{ path('admin_tournoi_index', app.request.query.all|merge({'type_game': 'Mind'})) }}" class="tab {{ filterTypeGame|default('') == 'Mind' ? 'active' : '' }}" data-type-game="Mind">Mind</a>
    </div>

    <div class="admin-tournament-panel admin-tournament-chart-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-chart-pie"></i>
            Repartition des statuts
        </div>
        <div data-ajax-search-chart>
            {% include 'admin/tournoi/_status_chart.html.twig' with {
                tournamentStatusChart: tournamentStatusChart,
                filteredTournamentCount: tournois|length
            } %}
        </div>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form method="GET" class="admin-tournament-form" data-ajax-search-form>
            <div class="field">
                <label>Nom du jeu</label>
                <input type="text" name="game" placeholder="ex: Valorant, Chess..." value="{{ filterGame }}" data-ajax-search-input>
            </div>
            <div class="field">
                <label>Type de jeu</label>
                <select name="type_game">
                    <option value="">-- Tous --</option>
                    <option value="FPS" {% if filterTypeGame == 'FPS' %}selected{% endif %}>FPS</option>
                    <option value="Sports" {% if filterTypeGame == 'Sports' %}selected{% endif %}>Sports</option>
                    <option value="Battle_royale" {% if filterTypeGame == 'Battle_royale' %}selected{% endif %}>Battle Royale</option>
                    <option value="Mind" {% if filterTypeGame == 'Mind' %}selected{% endif %}>Mind</option>
                </select>
            </div>
            <div class="field">
                <label>Type de tournoi</label>
                <select name="type_tournoi">
                    <option value="">-- Tous --</option>
                    <option value="solo" {% if filterTypeTournoi == 'solo' %}selected{% endif %}>Solo</option>
                    <option value="squad" {% if filterTypeTournoi == 'squad' %}selected{% endif %}>Squad</option>
                </select>
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="status">
                    <option value="">-- Tous --</option>
                    <option value="planned" {% if filterStatus == 'planned' %}selected{% endif %}>Planifié</option>
                    <option value="ongoing" {% if filterStatus == 'ongoing' %}selected{% endif %}>En cours</option>
                    <option value="finished" {% if filterStatus == 'finished' %}selected{% endif %}>Terminé</option>
                </select>
            </div>
            <input type="hidden" name="sort" value="{{ currentSort|default('') }}" data-sort-field>
            <input type="hidden" name="order" value="{{ currentOrder|default('ASC') }}" data-order-field>
            <input type="hidden" name="page" value="{{ currentPage|default(1) }}" data-page-field>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <a href="{{ path('admin_tournoi_index') }}" class="admin-tournament-btn ghost" data-reset-link>
                    <i class="fas fa-rotate"></i> Réinitialiser
                </a>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="{{ path('admin_tournoi_index', app.request.query.all | merge({'sort':'name','order':'asc'})) }}" data-sort="name:ASC">Nom A→Z</a>
            <a href="{{ path('admin_tournoi_index', app.request.query.all | merge({'sort':'name','order':'desc'})) }}" data-sort="name:DESC">Nom Z→A</a>
            <a href="{{ path('admin_tournoi_index', app.request.query.all | merge({'sort':'startDate','order':'asc'})) }}" data-sort="startDate:ASC">Date ↑</a>
            <a href="{{ path('admin_tournoi_index', app.request.query.all | merge({'sort':'startDate','order':'desc'})) }}" data-sort="startDate:DESC">Date ↓</a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="admin-tournament-alert success">
            <i class="fas fa-check-circle"></i> {{ message }}
        </div>
    {% endfor %}

        <div class="admin-tournament-table" data-ajax-search-table {% if not tournois %}style="display:none;"{% endif %}>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Type jeu</th>
                        <th>Type tournoi</th>
                        <th>Jeu</th>
                        <th>Statut</th>
                        <th>Début</th>
                        <th>Fin</th>
                        <th>Places restantes</th>
                        <th>Prix</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody data-ajax-search-rows>
                    {% include 'admin/tournoi/_table_rows.html.twig' with { tournois: tournois } %}
                </tbody>
            </table>
        </div>
        <div class="admin-tournament-empty" data-ajax-search-empty {% if tournois %}style="display:none;"{% endif %}>
            <div class="empty-ring"></div>
            <strong>Aucun tournoi trouvé</strong>
            <p>Commence par créer un nouveau tournoi.</p>
            <a href="{{ path('admin_tournoi_create') }}" class="admin-tournament-btn">
                <i class="fas fa-plus"></i> Créer le premier tournoi
            </a>
        </div>
        <div data-ajax-search-pagination>
            {% include 'admin/tournoi/_pagination.html.twig' with {
                pagination: pagination,
                query: app.request.query.all
            } %}
        </div>
</section>
{% endblock %}

{% block javascripts %}
{{ importmap('admin-chart') }}
<script>
(() => {
    const form = document.querySelector('[data-ajax-search-form]');
    if (!form) {
        return;
    }

    const searchInput = form.querySelector('[data-ajax-search-input]');
    const rowsContainer = document.querySelector('[data-ajax-search-rows]');
    const tableContainer = document.querySelector('[data-ajax-search-table]');
    const emptyState = document.querySelector('[data-ajax-search-empty]');
    const chartContainer = document.querySelector('[data-ajax-search-chart]');
    const tabs = document.querySelectorAll('.admin-tournament-tabs .tab[data-type-game]');
    const sortLinks = document.querySelectorAll('.admin-tournament-sort a[data-sort]');
    const sortField = form.querySelector('[data-sort-field]');
    const orderField = form.querySelector('[data-order-field]');
    const pageField = form.querySelector('[data-page-field]');
    const resetLink = form.querySelector('[data-reset-link]');
    const typeGameSelect = form.querySelector('select[name="type_game"]');
    const paginationContainer = document.querySelector('[data-ajax-search-pagination]');

    if (!searchInput || !rowsContainer || !tableContainer || !emptyState || !sortField || !orderField || !pageField || !typeGameSelect) {
        return;
    }

    const endpoint = '{{ path('admin_tournoi_search') }}';
    let debounceTimer = null;
    let currentController = null;

    const setActiveTypeGameTab = (typeGameValue) => {
        tabs.forEach((tab) => {
            tab.classList.toggle('active', (tab.dataset.typeGame || '') === typeGameValue);
        });
    };

    const updateVisibility = (count) => {
        if (count > 0) {
            tableContainer.style.display = '';
            emptyState.style.display = 'none';
            return;
        }
        tableContainer.style.display = 'none';
        emptyState.style.display = '';
    };

    const runSearch = () => {
        const params = new URLSearchParams(new FormData(form));
        if (currentController) {
            currentController.abort();
        }
        currentController = new AbortController();

        fetch(`${endpoint}?${params.toString()}`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            signal: currentController.signal
        })
            .then((response) => response.ok ? response.json() : Promise.reject(new Error('HTTP ' + response.status)))
            .then((data) => {
                rowsContainer.innerHTML = data.rows || '';
                updateVisibility(Number(data.count || 0));
                if (paginationContainer && typeof data.pagination === 'string') {
                    paginationContainer.innerHTML = data.pagination;
                }
                if (typeof data.page !== 'undefined') {
                    pageField.value = String(data.page);
                }
                if (chartContainer && typeof data.chart === 'string') {
                    chartContainer.innerHTML = data.chart;
                }
            })
            .catch((error) => {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Recherche AJAX échouée:', error);
            });
    };

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        runSearch();
    });

    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        pageField.value = '1';
        debounceTimer = setTimeout(runSearch, 180);
    });

    form.querySelectorAll('select').forEach((field) => {
        field.addEventListener('change', () => {
            pageField.value = '1';
            if (field.name === 'type_game') {
                setActiveTypeGameTab(field.value || '');
            }
            runSearch();
        });
    });

    tabs.forEach((tab) => {
        tab.addEventListener('click', (event) => {
            event.preventDefault();
            const typeGame = tab.dataset.typeGame || '';
            typeGameSelect.value = typeGame;
            setActiveTypeGameTab(typeGame);
            runSearch();
        });
    });

    sortLinks.forEach((link) => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const [sort, order] = (link.dataset.sort || '').split(':');
            if (!sort || !order) {
                return;
            }
            sortField.value = sort;
            orderField.value = order;
            pageField.value = '1';
            runSearch();
        });
    });

    if (resetLink) {
        resetLink.addEventListener('click', (event) => {
            event.preventDefault();
            form.querySelector('input[name="game"]').value = '';
            form.querySelector('select[name="type_game"]').value = '';
            form.querySelector('select[name="type_tournoi"]').value = '';
            form.querySelector('select[name="status"]').value = '';
            sortField.value = '';
            orderField.value = 'ASC';
            pageField.value = '1';
            setActiveTypeGameTab('');
            runSearch();
        });
    }

    document.addEventListener('click', (event) => {
        const target = event.target instanceof Element ? event.target.closest('[data-ajax-search-pagination] a[href]') : null;
        if (!target) {
            return;
        }

        event.preventDefault();
        try {
            const url = new URL(target.getAttribute('href'), window.location.origin);
            const requestedPage = url.searchParams.get('page') || '1';
            pageField.value = requestedPage;
            runSearch();
        } catch (e) {
            pageField.value = '1';
            runSearch();
        }
    });
})();
</script>
{% endblock %}
