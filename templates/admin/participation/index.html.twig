{% extends 'admin/layout.html.twig' %}

{% block title %}Demandes de participation{% endblock %}
{% block page_title %}Demandes de participation{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Demandes de participation</h2>
        <p class="admin-tournament-lead">Gérez les inscriptions aux tournois en attente de validation.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('admin_participation_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="{{ path('admin_participation_index', app.request.query.all|merge({'status': ''})) }}" class="tab {{ filterStatus|default('') == '' ? 'active' : '' }}" data-status="">Tous</a>
        <a href="{{ path('admin_participation_index', app.request.query.all|merge({'status': 'pending'})) }}" class="tab {{ filterStatus|default('') == 'pending' ? 'active' : '' }}" data-status="pending">En attente</a>
        <a href="{{ path('admin_participation_index', app.request.query.all|merge({'status': 'approved'})) }}" class="tab {{ filterStatus|default('') == 'approved' ? 'active' : '' }}" data-status="approved">Approuvées</a>
        <a href="{{ path('admin_participation_index', app.request.query.all|merge({'status': 'rejected'})) }}" class="tab {{ filterStatus|default('') == 'rejected' ? 'active' : '' }}" data-status="rejected">Rejetées</a>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form method="GET" class="admin-tournament-form" data-participation-ajax-form>
            <div class="field">
                <label>Tournoi</label>
                <input type="text" name="tournoi" placeholder="Nom du tournoi" value="{{ filterTournoi|default('') }}" data-ajax-input>
            </div>
            <div class="field">
                <label>Utilisateur</label>
                <input type="text" name="user" placeholder="Pseudo ou email" value="{{ filterUser|default('') }}" data-ajax-input>
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="status">
                    <option value="">-- Tous --</option>
                    <option value="pending" {% if filterStatus|default('') == 'pending' %}selected{% endif %}>En attente</option>
                    <option value="approved" {% if filterStatus|default('') == 'approved' %}selected{% endif %}>Approuvée</option>
                    <option value="rejected" {% if filterStatus|default('') == 'rejected' %}selected{% endif %}>Rejetée</option>
                </select>
            </div>
            <input type="hidden" name="sort" value="{{ currentSort|default('createdAt') }}" data-sort-field>
            <input type="hidden" name="order" value="{{ currentOrder|default('DESC') }}" data-order-field>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <a href="{{ path('admin_participation_index') }}" class="admin-tournament-btn ghost" data-reset-link>
                    <i class="fas fa-rotate"></i> Réinitialiser
                </a>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="{{ path('admin_participation_index', app.request.query.all|merge({'sort':'createdAt','order':'DESC'})) }}" data-sort="createdAt:DESC">Date ↓</a>
            <a href="{{ path('admin_participation_index', app.request.query.all|merge({'sort':'createdAt','order':'ASC'})) }}" data-sort="createdAt:ASC">Date ↑</a>
            <a href="{{ path('admin_participation_index', app.request.query.all|merge({'sort':'status','order':'ASC'})) }}" data-sort="status:ASC">Statut A→Z</a>
            <a href="{{ path('admin_participation_index', app.request.query.all|merge({'sort':'status','order':'DESC'})) }}" data-sort="status:DESC">Statut Z→A</a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="admin-tournament-alert success">
            <i class="fas fa-check-circle"></i> {{ message }}
        </div>
    {% endfor %}

    {% for message in app.flashes('error') %}
        <div class="admin-tournament-alert">
            <i class="fas fa-exclamation-triangle"></i> {{ message }}
        </div>
    {% endfor %}

        <div class="admin-tournament-table" data-ajax-table {% if not requests %}style="display:none;"{% endif %}>
            <table data-table="participations">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tournoi</th>
                        <th>Pseudo</th>
                        <th>Nom utilisateur</th>
                        <th>Email</th>
                        <th>Niveau joueur</th>
                        <th>Message</th>
                        <th>Statut</th>
                        <th>Créée le</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody data-ajax-rows>
                    {% include 'admin/participation/_table_rows.html.twig' with { requests: requests } %}
                </tbody>
            </table>
        </div>
        <div class="admin-tournament-empty" data-ajax-empty {% if requests %}style="display:none;"{% endif %}>
            <div class="empty-ring"></div>
            <strong>Aucune demande trouvée</strong>
            <p>Les nouvelles participations s'afficheront ici.</p>
        </div>
</section>

{% endblock %}

{% block javascripts %}
<script>
(() => {
    const form = document.querySelector('[data-participation-ajax-form]');
    if (!form) {
        return;
    }

    const rowsContainer = document.querySelector('[data-ajax-rows]');
    const tableContainer = document.querySelector('[data-ajax-table]');
    const emptyState = document.querySelector('[data-ajax-empty]');
    const tabs = document.querySelectorAll('.admin-tournament-tabs .tab[data-status]');
    const sortLinks = document.querySelectorAll('.admin-tournament-sort a[data-sort]');
    const sortField = form.querySelector('[data-sort-field]');
    const orderField = form.querySelector('[data-order-field]');
    const resetLink = form.querySelector('[data-reset-link]');
    const ajaxInputs = form.querySelectorAll('[data-ajax-input]');

    if (!rowsContainer || !tableContainer || !emptyState || !sortField || !orderField) {
        return;
    }

    const endpoint = '{{ path('admin_participation_search') }}';
    let debounceTimer = null;
    let currentController = null;

    const setActiveTab = (statusValue) => {
        tabs.forEach((tab) => {
            tab.classList.toggle('active', (tab.dataset.status || '') === statusValue);
        });
    };

    const updateVisibility = (count) => {
        if (count > 0) {
            tableContainer.style.display = '';
            emptyState.style.display = 'none';
            return;
        }
        tableContainer.style.display = 'none';
        emptyState.style.display = '';
    };

    const runSearch = () => {
        const params = new URLSearchParams(new FormData(form));
        if (currentController) {
            currentController.abort();
        }
        currentController = new AbortController();

        fetch(`${endpoint}?${params.toString()}`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            signal: currentController.signal
        })
            .then((response) => response.ok ? response.json() : Promise.reject(new Error('HTTP ' + response.status)))
            .then((data) => {
                rowsContainer.innerHTML = data.rows || '';
                updateVisibility(Number(data.count || 0));
            })
            .catch((error) => {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Recherche AJAX échouée:', error);
            });
    };

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        runSearch();
    });

    ajaxInputs.forEach((input) => {
        input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(runSearch, 180);
        });
    });

    form.querySelectorAll('select[name="status"]').forEach((select) => {
        select.addEventListener('change', () => {
            setActiveTab(select.value || '');
            runSearch();
        });
    });

    tabs.forEach((tab) => {
        tab.addEventListener('click', (event) => {
            event.preventDefault();
            const status = tab.dataset.status || '';
            const statusSelect = form.querySelector('select[name="status"]');
            if (statusSelect) {
                statusSelect.value = status;
            }
            setActiveTab(status);
            runSearch();
        });
    });

    sortLinks.forEach((link) => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const [sort, order] = (link.dataset.sort || '').split(':');
            if (!sort || !order) {
                return;
            }
            sortField.value = sort;
            orderField.value = order;
            runSearch();
        });
    });

    if (resetLink) {
        resetLink.addEventListener('click', (event) => {
            event.preventDefault();
            form.querySelector('input[name="tournoi"]').value = '';
            form.querySelector('input[name="user"]').value = '';
            form.querySelector('select[name="status"]').value = '';
            sortField.value = 'createdAt';
            orderField.value = 'DESC';
            setActiveTab('');
            runSearch();
        });
    }
})();
</script>
{% endblock %}
