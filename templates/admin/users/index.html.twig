{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des Comptes - Admin{% endblock %}
{% block page_title %}Gestion des Comptes{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <style>
        .admin-pagination-wrap {
            margin-top: 18px;
            display: flex;
            justify-content: center;
        }
        .admin-pagination {
            display: inline-flex !important;
            align-items: center !important;
            gap: 8px !important;
            padding: 10px 12px !important;
            border-radius: 14px !important;
            border: 1px solid rgba(79, 209, 255, 0.24) !important;
            background: rgba(8, 14, 30, 0.72) !important;
            backdrop-filter: blur(10px);
        }
        .admin-pagination-btn,
        .admin-pagination-page {
            min-width: 36px !important;
            height: 36px !important;
            padding: 0 12px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 10px !important;
            border: 1px solid rgba(255, 255, 255, 0.13) !important;
            background: rgba(255, 255, 255, 0.06) !important;
            color: #dbe7ff !important;
            text-decoration: none !important;
            font-weight: 700 !important;
            line-height: 1 !important;
        }
        .admin-pagination-page.is-active {
            border-color: rgba(56, 189, 248, 0.65) !important;
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.32), rgba(59, 130, 246, 0.34)) !important;
            color: #fff !important;
        }
        .admin-pagination-btn.is-disabled {
            opacity: .35 !important;
            pointer-events: none !important;
        }
    </style>
{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Gestion des Comptes</h2>
        <p class="admin-tournament-lead">Administrez les utilisateurs et leurs rôles.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('app_admin_user_new') }}" class="admin-tournament-btn">
                <i class="fas fa-plus"></i> Créer un compte
            </a>
            <a href="{{ path('admin_users') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="{{ path('admin_users', app.request.query.all | merge({'role': ''})) }}"
           class="tab {{ currentRole is empty ? 'active' : '' }}">Tous</a>
        <a href="{{ path('admin_users', app.request.query.all | merge({'role': 'ROLE_ADMIN'})) }}"
           class="tab {{ currentRole == 'ROLE_ADMIN' ? 'active' : '' }}">Admin</a>
        <a href="{{ path('admin_users', app.request.query.all | merge({'role': 'ROLE_MANAGER'})) }}"
           class="tab {{ currentRole == 'ROLE_MANAGER' ? 'active' : '' }}">Manager</a>
        <a href="{{ path('admin_users', app.request.query.all | merge({'role': 'ROLE_JOUEUR'})) }}"
           class="tab {{ currentRole == 'ROLE_JOUEUR' ? 'active' : '' }}">Joueur</a>
        <a href="{{ path('admin_users', app.request.query.all | merge({'role': 'ROLE_ORGANISATEUR'})) }}"
           class="tab {{ currentRole == 'ROLE_ORGANISATEUR' ? 'active' : '' }}">Organisateur</a>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form method="GET" class="admin-tournament-form" data-admin-users-form>
            <div class="field">
                <label>Nom, email ou pseudo</label>
                <input type="text" name="q" placeholder="Rechercher..." value="{{ currentQuery }}" data-admin-users-query>
            </div>
            <div class="field">
                <label>Rôle</label>
                <select name="role" data-admin-users-role>
                    <option value="">-- Tous --</option>
                    <option value="ROLE_ADMIN" {% if currentRole == 'ROLE_ADMIN' %}selected{% endif %}>Admin</option>
                    <option value="ROLE_MANAGER" {% if currentRole == 'ROLE_MANAGER' %}selected{% endif %}>Manager</option>
                    <option value="ROLE_JOUEUR" {% if currentRole == 'ROLE_JOUEUR' %}selected{% endif %}>Joueur</option>
                    <option value="ROLE_ORGANISATEUR" {% if currentRole == 'ROLE_ORGANISATEUR' %}selected{% endif %}>Organisateur</option>
                </select>
            </div>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <a href="{{ path('admin_users') }}" class="admin-tournament-btn ghost">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </a>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="{{ path('admin_users', app.request.query.all | merge({'sort':'nom','direction':'ASC'})) }}">Nom A→Z</a>
            <a href="{{ path('admin_users', app.request.query.all | merge({'sort':'nom','direction':'DESC'})) }}">Nom Z→A</a>
            <a href="{{ path('admin_users', app.request.query.all | merge({'sort':'id','direction':'DESC'})) }}">ID ↓</a>
            <a href="{{ path('admin_users', app.request.query.all | merge({'sort':'id','direction':'ASC'})) }}">ID ↑</a>
        </div>
    </div>

    <div id="admin-users-results" data-sort="{{ currentSort }}" data-direction="{{ currentDirection }}" data-page="{{ currentPage|default(1) }}">
        {% include 'admin/users/_table.html.twig' with { users: users, pagination: pagination, query: app.request.query.all } %}
    </div>
</section>

<script>
(() => {
    const form = document.querySelector('[data-admin-users-form]');
    const queryInput = document.querySelector('[data-admin-users-query]');
    const roleSelect = document.querySelector('[data-admin-users-role]');
    const results = document.getElementById('admin-users-results');
    if (!form || !queryInput || !roleSelect || !results) {
        return;
    }

    let debounceTimer = null;
    let currentRequest = null;

    const buildUrl = () => {
        const params = new URLSearchParams();
        const query = queryInput.value.trim();
        const role = roleSelect.value;
        const sort = results.dataset.sort || 'id';
        const direction = results.dataset.direction || 'DESC';
        const page = results.dataset.page || '1';

        if (query !== '') {
            params.set('q', query);
        }
        if (role !== '') {
            params.set('role', role);
        }
        if (sort) {
            params.set('sort', sort);
        }
        if (direction) {
            params.set('direction', direction);
        }
        params.set('page', page);
        params.set('ajax', '1');

        return `${form.action || window.location.pathname}?${params.toString()}`;
    };

    const fetchResults = () => {
        if (currentRequest) {
            currentRequest.abort();
        }
        const controller = new AbortController();
        currentRequest = controller;
        results.classList.add('is-loading');

        fetch(buildUrl(), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            signal: controller.signal
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error('Request failed');
                }
                return response.text();
            })
            .then((html) => {
                results.innerHTML = html;
                results.dataset.page = results.dataset.page || '1';
                results.classList.remove('is-loading');
            })
            .catch((error) => {
                if (error.name !== 'AbortError') {
                    results.classList.remove('is-loading');
                }
            });
    };

    const scheduleFetch = () => {
        window.clearTimeout(debounceTimer);
        results.dataset.page = '1';
        debounceTimer = window.setTimeout(fetchResults, 300);
    };

    queryInput.addEventListener('input', scheduleFetch);
    roleSelect.addEventListener('change', () => {
        results.dataset.page = '1';
        fetchResults();
    });
    form.addEventListener('submit', (event) => {
        event.preventDefault();
        results.dataset.page = '1';
        fetchResults();
    });

    document.addEventListener('click', (event) => {
        const target = event.target instanceof Element ? event.target.closest('#admin-users-results .admin-pagination a[href]') : null;
        if (!target) {
            return;
        }

        event.preventDefault();
        try {
            const url = new URL(target.getAttribute('href'), window.location.origin);
            results.dataset.page = url.searchParams.get('page') || '1';
        } catch (e) {
            results.dataset.page = '1';
        }
        fetchResults();
    });
})();
</script>
{% endblock %}
