{% extends 'base.html.twig' %}

{% block title %}Tournois{% endblock %}

{% block body %}
<section class="tournoi-hero">
    <div class="tournoi-hero-inner">
        <div class="tournoi-kicker">Arena</div>
        <h1 class="tournoi-title">Tournois</h1>
        <p class="tournoi-lead">Cyber arena pour joueurs, squads et managers. Filtre, explore, rejoins.</p>
        <div class="tournoi-hero-actions">
            <a href="{{ path('tournoi_participation_requests') }}" class="neo-btn">Mes demandes</a>
            <a href="{{ path('fil_home') }}" class="neo-btn ghost">Voir le fil</a>
            <a href="{{ path('app_rawg_browser', filterGame ? {'q': filterGame} : {}) }}" target="_blank" rel="noopener noreferrer" class="neo-btn ghost">Consulter jeux</a>
        </div>
    </div>
    <div class="tournoi-hero-glow"></div>
</section>

<section class="tournoi-shell">
    <div class="tournoi-panel">
        <form method="GET" class="tournoi-filter">
            <div class="field">
                <label>Game</label>
                <input type="text" name="game" value="{{ filterGame|default('') }}" placeholder="Valorant, CS2, Chess">
            </div>
            <div class="field">
                <label>Type de jeu</label>
                <select name="type_game">
                    <option value="">Tous</option>
                    <option value="FPS" {% if filterTypeGame == 'FPS' %}selected{% endif %}>FPS</option>
                    <option value="Sports" {% if filterTypeGame == 'Sports' %}selected{% endif %}>Sports</option>
                    <option value="Battle_royale" {% if filterTypeGame == 'Battle_royale' %}selected{% endif %}>Battle Royale</option>
                    <option value="Mind" {% if filterTypeGame == 'Mind' %}selected{% endif %}>Mind</option>
                </select>
            </div>
            <div class="field">
                <label>Type de tournoi</label>
                <select name="type_tournoi">
                    <option value="">Tous</option>
                    <option value="solo" {% if filterTypeTournoi == 'solo' %}selected{% endif %}>Solo</option>
                    <option value="squad" {% if filterTypeTournoi == 'squad' %}selected{% endif %}>Squad</option>
                </select>
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="status">
                    <option value="">Tous</option>
                    <option value="planned" {% if filterStatus == 'planned' %}selected{% endif %}>Planifie</option>
                    <option value="ongoing" {% if filterStatus == 'ongoing' %}selected{% endif %}>En cours</option>
                    <option value="finished" {% if filterStatus == 'finished' %}selected{% endif %}>Termine</option>
                </select>
            </div>
            <div class="field actions">
                <button type="submit" class="neo-btn">Rechercher</button>
                <a href="{{ path('tournoi_index') }}" class="neo-btn ghost">Reinitialiser</a>
            </div>
        </form>
        <div class="tournoi-sort">
            <span>Trier :</span>
            <a href="{{ path('tournoi_index', app.request.query.all | merge({'sort':'name','order':'asc'})) }}">Nom A->Z</a>
            <a href="{{ path('tournoi_index', app.request.query.all | merge({'sort':'name','order':'desc'})) }}">Nom Z->A</a>
            <a href="{{ path('tournoi_index', app.request.query.all | merge({'sort':'startDate','order':'asc'})) }}">Date up</a>
            <a href="{{ path('tournoi_index', app.request.query.all | merge({'sort':'startDate','order':'desc'})) }}">Date down</a>
        </div>
        <div class="tournoi-tabs">
            <a href="{{ path('tournoi_index') }}" class="tab active">All</a>
            <a href="{{ path('tournoi_by_category', {typeGame: 'FPS'}) }}" class="tab">FPS</a>
            <a href="{{ path('tournoi_by_category', {typeGame: 'Sports'}) }}" class="tab">Sports</a>
            <a href="{{ path('tournoi_by_category', {typeGame: 'Battle_royale'}) }}" class="tab">Battle Royale</a>
            <a href="{{ path('tournoi_by_category', {typeGame: 'Mind'}) }}" class="tab">Mind</a>
        </div>
    </div>

    {% if tournois %}
        <div class="tournoi-grid">
            {% for tournoi in tournois %}
                {% set delay = loop.index0 * 0.05 %}
                <article class="tournoi-card" style="animation-delay: {{ delay }}s;">
                    <header>
                        <div class="name">{{ tournoi.name }}</div>
                        <div class="badges">
                            <span class="badge info">{{ tournoi.typeGame }}</span>
                            <span class="badge muted">{{ tournoi.typeTournoi|upper }}</span>
                        </div>
                    </header>

                    <div class="meta">
                        <div>
                            <span>Game</span>
                            <strong>{{ tournoi.game }}</strong>
                        </div>
                        <div>
                            <span>Statut</span>
                            {% if tournoi.currentStatus == 'planned' %}
                                <strong class="status warn">Planifie</strong>
                            {% elseif tournoi.currentStatus == 'ongoing' %}
                                <strong class="status success">En cours</strong>
                            {% else %}
                                <strong class="status danger">Termine</strong>
                            {% endif %}
                        </div>
                        <div>
                            <span>Places</span>
                            <strong>
                                {% if tournoi.remainingPlaces is null %}
                                    inf
                                {% else %}
                                    {{ tournoi.remainingPlaces }} / {{ tournoi.maxPlaces }}
                                {% endif %}
                            </strong>
                        </div>
                    </div>

                    <div class="meta">
                        <div>
                            <span>Debut</span>
                            <strong>{{ tournoi.startDate|date('Y-m-d H:i') }}</strong>
                        </div>
                        <div>
                            <span>Fin</span>
                            <strong>{{ tournoi.endDate|date('Y-m-d H:i') }}</strong>
                        </div>
                        <div>
                            <span>Prize</span>
                            <strong>${{ tournoi.prizeWon }}</strong>
                        </div>
                    </div>

                    <div class="request-status">
                        {% set reqStatus = requestStatuses[tournoi.idTournoi]|default(null) %}
                        {% if participantTournoiIds[tournoi.idTournoi]|default(false) %}
                            <span class="badge success">Approuvee</span>
                        {% elseif reqStatus %}
                            {% if reqStatus in ['pending', 'en_attente'] %}
                                <span class="badge info">En attente</span>
                            {% elseif reqStatus in ['approved', 'approuvee', 'approuvee'] %}
                                <span class="badge success">Approuvee</span>
                            {% elseif reqStatus in ['rejected', 'rejetee', 'rejete'] %}
                                <span class="badge danger">Rejetee</span>
                            {% else %}
                                <span class="badge muted">{{ reqStatus }}</span>
                            {% endif %}
                        {% else %}
                            <span class="badge muted">Aucune demande</span>
                        {% endif %}
                    </div>

                    <footer class="actions">
                        <a href="{{ path('tournoi_show', {id: tournoi.idTournoi}) }}" class="neo-btn ghost">Voir</a>
                        {% set alreadyIn = participantTournoiIds[tournoi.idTournoi]|default(false) %}
                        {% set alreadyRequested = requestTournoiIds[tournoi.idTournoi]|default(false) %}
                        {% set isSquad = tournoi.typeTournoi == 'squad' %}
                        {% if app.user and alreadyIn %}
                            <button class="neo-btn" disabled>Deja inscrit</button>
                        {% elseif app.user and alreadyRequested %}
                            <button class="neo-btn" disabled>Demande envoyee</button>
                        {% else %}
                            {% if tournoi.currentStatus == 'planned' and (tournoi.remainingPlaces is null or tournoi.remainingPlaces > 0) %}
                                {% if app.user and isSquad and not userHasTeam %}
                                    <span id="join-msg-{{ tournoi.idTournoi }}" class="badge danger join-inline-message" style="display:none;">Tu dois etre dans une equipe pour participer</span>
                                    <button
                                        type="button"
                                        class="neo-btn join-squad-blocked"
                                        data-msg-id="join-msg-{{ tournoi.idTournoi }}"
                                    >
                                        Rejoindre
                                    </button>
                                {% else %}
                                    <a href="{{ path('tournoi_participate', {id: tournoi.idTournoi}) }}" class="neo-btn">Rejoindre</a>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </footer>
                </article>
            {% endfor %}
        </div>
    {% else %}
        <div class="tournoi-empty">
            <div class="empty-ring"></div>
            <strong>Aucun tournoi trouve.</strong>
            <span>Reviens plus tard pour les prochaines competitions.</span>
        </div>
    {% endif %}
</section>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.querySelectorAll('.join-squad-blocked').forEach(function (button) {
            button.addEventListener('click', function () {
                var msgId = button.getAttribute('data-msg-id');
                var msg = document.getElementById(msgId);
                if (msg) {
                    msg.style.display = 'inline-flex';
                }
            });
        });
    </script>
{% endblock %}
