{% extends 'base.html.twig' %}

{% block title %}Boutique – E-Sportify{% endblock %}

{% block stylesheets %}
<style>
    :root {
        --bg-deep: #0a0e23;
        --card-bg: #1b1e2e;
        --primary-pink: #f72585;
        --primary-blue: #4361ee;
        --text-muted: #8d91a5;
    }

    .container { width: 95%; max-width: 1400px; margin: 0 auto; padding: 40px 0; }
    
    .store-header { text-align: center; margin-bottom: 50px; }
    .store-title { font-family: 'Orbitron', sans-serif; font-size: 3rem; font-weight: 900; letter-spacing: 2px; margin-bottom: 10px; }
    .store-subtitle { color: var(--text-muted); font-size: 1.1rem; }

    .actions-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; gap: 20px; flex-wrap: wrap; }
    
    .search-wrapper { position: relative; flex: 1; max-width: 800px; }
    .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 1.2rem; }
    .search-wrapper input { width: 100%; padding: 18px 20px 18px 55px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: #fff; font-size: 1.1rem; transition: 0.3s; }
    .search-wrapper input:focus { border-color: var(--primary-blue); background: rgba(255,255,255,0.06); outline: none; box-shadow: 0 0 15px rgba(67, 97, 238, 0.2); }

    .sort-dropdown { position: relative; z-index: 1000; }
    .sort-btn { padding: 12px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; }
    .sort-menu { position: absolute; right: 0; top: 100%; margin-top: 10px; background: #1b1e2e; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; min-width: 200px; display: none; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    /* Bridge the gap so hover doesn't break */
    .sort-dropdown:after { content: ''; position: absolute; top: 100%; left: 0; right: 0; height: 10px; }
    .sort-dropdown:hover .sort-menu, .sort-menu.show { display: block; }
    .sort-menu a { display: block; padding: 12px 20px; color: var(--text-muted); text-decoration: none; transition: 0.2s; }
    .sort-menu a:hover, .sort-menu a.active { background: rgba(255,255,255,0.05); color: #fff; }

    .category-nav { display: flex; justify-content: center; gap: 15px; margin-bottom: 50px; flex-wrap: wrap; }
    .cat-btn { padding: 10px 25px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); border-radius: 30px; cursor: pointer; text-decoration: none; font-weight: 600; transition: 0.3s; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
    .cat-btn:hover, .cat-btn.active { background: var(--primary-blue); border-color: var(--primary-blue); color: #fff; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }

    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
    
    .product-card { background: var(--card-bg); border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
    .product-card:hover { transform: translateY(-10px); border-color: rgba(67, 97, 238, 0.3); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }

    .card-image-wrapper { height: 250px; position: relative; background: #0c0f1d; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .card-image-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
    .product-card:hover .card-image-wrapper img { transform: scale(1.1); filter: brightness(0.7); }

    .card-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; background: rgba(10, 14, 35, 0.6); }
    .product-card:hover .card-overlay { opacity: 1; }
    .btn-view { padding: 12px 25px; background: #fff; color: #000; text-decoration: none; border-radius: 30px; font-weight: 700; transform: translateY(20px); transition: 0.4s; }
    .product-card:hover .btn-view { transform: translateY(0); }

    .badge-rupture { position: absolute; top: 15px; right: 15px; background: #ff4d4d; color: #fff; padding: 5px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; }
    .badge-low { position: absolute; top: 15px; right: 15px; background: #ff9f43; color: #000; padding: 5px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; }

    .card-content { padding: 25px; }
    .card-category { color: var(--primary-pink); font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .card-title { font-family: 'Orbitron', sans-serif; font-size: 1.25rem; margin-bottom: 20px; color: #fff; }
    
    .card-footer { display: flex; justify-content: space-between; align-items: center; }
    .price { font-size: 1.6rem; font-weight: 900; color: #fff; font-family: 'Orbitron', sans-serif; }
    .btn-cart { width: 45px; height: 45px; border-radius: 12px; background: var(--primary-blue); border: none; color: #fff; cursor: pointer; transition: 0.3s; font-size: 1.1rem; }
    .btn-cart:hover { transform: rotate(15deg) scale(1.1); box-shadow: 0 0 15px var(--primary-blue); }

    .empty-state { grid-column: 1/-1; text-align: center; padding: 100px 0; color: var(--text-muted); }
    .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.2; }
</style>
{% endblock %}

{% block body %}
<div class="container" data-controller="filter">
    <div class="store-header animate__animated animate__fadeInDown">
        <h1 class="store-title">BOUTIQUE <span style="color: var(--primary-pink, #f72585);">PREMIUM</span></h1>
        <p class="store-subtitle">Équipez-vous avec le meilleur matériel officiel E-Sportify.</p>
    </div>

    <div class="actions-bar animate__animated animate__fadeInUp">
        <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="live-search-input" placeholder="Rechercher un équipement..." value="{{ current_search|default('') }}">
        </div>

        <div class="filter-group">
            <div class="sort-dropdown">
                <button class="sort-btn">Trier par <i class="fas fa-chevron-down"></i></button>
                <div class="sort-menu">
                    <a href="#" data-sort="price" data-dir="asc" class="{{ current_sort|default('') == 'p.prix' and current_dir|default('') == 'ASC' ? 'active' : '' }}">Prix Croissant</a>
                    <a href="#" data-sort="price" data-dir="desc" class="{{ current_sort|default('') == 'p.prix' and current_dir|default('') == 'DESC' ? 'active' : '' }}">Prix Décroissant</a>
                    <a href="#" data-sort="name" data-dir="asc" class="{{ current_sort|default('') == 'p.nom' ? 'active' : '' }}">Nom (A-Z)</a>
                </div>
            </div>
        </div>
    </div>

    <div class="category-nav animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
        <a href="{{ path('app_front_produit_index') }}" class="cat-btn {{ current_category is empty ? 'active' : '' }}">
            <i class="fas fa-th-large"></i> Tous
        </a>
        {% for cat in categories %}
            <a href="{{ path('app_front_produit_index', { 'categorie': cat.id, 'q': current_search, 'sort': current_sort, 'dir': current_dir }) }}" 
               class="cat-btn {{ current_category == cat.id ? 'active' : '' }}">
                {{ cat.nom|upper }}
            </a>
        {% endfor %}
    </div>

    <div class="product-grid animate__animated animate__fadeInUp" style="animation-delay: 0.2s;" id="product-grid">
        {% for produit in produits %}
            <div class="product-card" data-price="{{ produit.prix }}" data-name="{{ produit.nom|lower }}">
                <div class="card-image-wrapper">
                    {% if produit.image %}
                        <img src="{{ produit.image starts with 'http' ? produit.image : asset(produit.image) }}" alt="{{ produit.nom }}" onerror="this.src='https://placehold.co/400x400/1b1e2e/FFF?text=E-Sportify'">
                    {% else %}
                        <img src="https://placehold.co/400x400/1b1e2e/FFF?text=E-Sportify" alt="{{ produit.nom }}">
                    {% endif %}
                    <div class="card-overlay">
                        <a href="{{ path('app_front_produit_show', { id: produit.id }) }}" class="btn-view">
                            <i class="fas fa-eye"></i> Voir Détails
                        </a>
                    </div>
                    {% if produit.stock == 0 %}
                        <div class="badge-rupture">RUPTURE</div>
                    {% elseif produit.stock < 5 %}
                        <div class="badge-low">Derniers articles</div>
                    {% endif %}
                </div>
                
                <div class="card-content">
                    <div class="card-category">{{ produit.categorie ? produit.categorie.nom : 'Divers' }}</div>
                    <h3 class="card-title">{{ produit.nom }}</h3>
                    
                    <div class="card-footer">
                        <div class="price">{{ produit.prix|number_format(2) }} €</div>
                        <button class="btn-cart" title="Ajouter au panier">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-ghost"></i>
                <h3>Aucun produit trouvé</h3>
                <p>Essayez une autre recherche ou revenez plus tard.</p>
            </div>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('product-grid');
        const sortLinks = document.querySelectorAll('.sort-menu a');
        const sortBtn = document.querySelector('.sort-btn');
        const sortMenu = document.querySelector('.sort-menu');
        const liveSearchInput = document.getElementById('live-search-input');

        // ===== LIVE SEARCH FUNCTIONALITY =====
        if (liveSearchInput) {
            liveSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const productCards = document.querySelectorAll('.product-card');
                let visibleCount = 0;

                productCards.forEach(card => {
                    const productName = card.dataset.name || '';
                    
                    if (productName.includes(searchTerm)) {
                        card.style.display = '';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Show/hide empty state
                let emptyState = document.querySelector('.empty-state');
                if (visibleCount === 0 && searchTerm !== '') {
                    if (!emptyState) {
                        emptyState = document.createElement('div');
                        emptyState.className = 'empty-state';
                        emptyState.innerHTML = `
                            <i class="fas fa-ghost"></i>
                            <h3>Aucun produit trouvé</h3>
                            <p>Aucun produit ne correspond à "${e.target.value}"</p>
                        `;
                        grid.appendChild(emptyState);
                    } else {
                        emptyState.style.display = '';
                        emptyState.querySelector('p').textContent = `Aucun produit ne correspond à "${e.target.value}"`;
                    }
                } else if (emptyState) {
                    emptyState.style.display = 'none';
                }
            });
        }

        // ===== SORT DROPDOWN TOGGLE =====
        if(sortBtn){
            sortBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                sortMenu.classList.toggle('show');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (sortBtn && !sortBtn.contains(e.target) && sortMenu && !sortMenu.contains(e.target)) {
                sortMenu.classList.remove('show');
            }
        });
        
        sortLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                sortMenu.classList.remove('show'); // Close menu after selection

                const sortType = link.dataset.sort;
                const sortDir = link.dataset.dir;
                
                // Update active state
                sortLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                // Update button text to reflect choice
                sortBtn.innerHTML = link.textContent + ' <i class="fas fa-chevron-down"></i>';
                
                // Sort Logic - only sort visible cards
                const cards = Array.from(grid.getElementsByClassName('product-card'));
                const visibleCards = cards.filter(card => card.style.display !== 'none');
                
                visibleCards.sort((a, b) => {
                    let valA, valB;
                    
                    if (sortType === 'price') {
                        valA = parseFloat(a.dataset.price);
                        valB = parseFloat(b.dataset.price);
                    } else {
                        valA = a.dataset.name;
                        valB = b.dataset.name;
                    }
                    
                    if (valA < valB) return sortDir === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });
                
                // Re-append sorted cards
                visibleCards.forEach(card => grid.appendChild(card));
            });
        });
    });
</script>

<!-- CHATBOT INTEGRATION FOR STORE PAGE -->
<button id="chatbot-toggle-store" class="chatbot-btn" style="display: flex !important; position: fixed !important; top: 130px !important; bottom: auto !important; right: 20px !important; z-index: 2147483647 !important; width: 70px !important; height: 70px !important; opacity: 1 !important; visibility: visible !important;">
    <i class="fas fa-robot"></i>
    <span class="pulse-ring"></span>
</button>

<div id="chatbot-window-store" class="chatbot-window">
    <div class="chatbot-header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="robot-avatar"><i class="fas fa-robot"></i></div>
            <div>
                <div style="font-weight: 800; font-size: 14px; color: #fff;">NEXUS_AI</div>
                <div style="font-size: 10px; color: var(--success-color); display: flex; align-items: center; gap: 4px;">
                    <i class="fas fa-circle" style="font-size: 6px;"></i> EN LIGNE
                </div>
            </div>
        </div>
        <button id="chatbot-close-store" style="background:none;border:none;color:#fff;cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div id="chatbot-messages-store" class="chatbot-messages">
        <div class="bot-msg">Bonjour ! Je peux vous aider à filtrer les produits ou trouver un équipement spécifique dans la boutique.</div>
    </div>
    <div class="chatbot-input-area">
        <input type="text" id="chatbot-input-store" placeholder="Posez une question sur nos produits...">
        <button id="chatbot-send-store"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", ()=>{

        const btn = document.getElementById("chatbot-toggle-store");
        const box = document.getElementById("chatbot-window-store");
        const close = document.getElementById("chatbot-close-store");
        
        // Chatbot functionality elements
        const input = document.getElementById('chatbot-input-store');
        const send = document.getElementById('chatbot-send-store');
        const messages = document.getElementById('chatbot-messages-store');

        // Hide base toggle if exists
        const baseToggle = document.getElementById('chatbot-toggle');
        if(baseToggle) baseToggle.style.display = 'none';

        /* OUVRIR / FERMER CHATBOT */

        if(btn && box){
            btn.addEventListener("click", (e)=>{
                e.preventDefault();
                box.classList.toggle("active");
                if(box.classList.contains("active") && input) input.focus();
            });
        }

        if(close && box){
            close.addEventListener("click", (e)=>{
                e.preventDefault();
                box.classList.remove("active");
            });
        }

        // --- Chat Processing Logic ---
        const addMessage = (content, role) => {
            const div = document.createElement('div');
            div.className = role === 'bot' ? 'bot-msg' : 'user-msg';
            div.textContent = content;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        };

        const processChat = async () => {
            const message = input.value.trim();
            if(!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            const loading = document.createElement('div');
            loading.className = 'bot-msg';
            loading.textContent = '...';
            messages.appendChild(loading);

            try {
                const productNames = Array.from(document.querySelectorAll('.card-title')).map(el => el.textContent).join(', ').slice(0, 300);
                const context = "L'utilisateur est sur la BOUTIQUE. Produits visibles : " + productNames;

                const response = await fetch('/api/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message, 
                        history: [],
                        page: 'Boutique', 
                        url: window.location.href,
                        context: context
                    })
                });
                const data = await response.json();
                loading.remove();
                addMessage(data.response, 'bot');
            } catch (e) {
                loading.textContent = "Erreur de connexion.";
            }
        };

        if(send) send.onclick = processChat;
        if(input) input.onkeypress = (e) => { if(e.key === 'Enter') processChat(); };
    });
</script>

<style>
    /* Base styles */
    .chatbot-btn {
        position: fixed; top: 130px; right: 30px; width: 65px; height: 65px;
        bottom: auto !important; 
        border-radius: 50%; background: linear-gradient(135deg, #4361ee, #4cc9f0);
        border: none; color: white; font-size: 24px; cursor: pointer;
        z-index: 2147483647; box-shadow: 0 10px 30px rgba(67, 97, 238, 0.4);
        display: flex; align-items: center; justify-content: center;
    }
    
    .chatbot-window {
        position: fixed; top: 210px; right: 30px; width: 350px; height: 450px;
        bottom: auto !important;
        background: #1b1e2e; border-radius: 20px; 
        
        display: none; /* Changed as requested */
        
        flex-direction: column;
        z-index: 2147483647; border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .chatbot-window.active {
        display: flex !important; /* Force flex when active */
    }

    .chatbot-header { padding: 15px; background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
    .chatbot-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .bot-msg { background: rgba(255,255,255,0.1); color: #fff; padding: 10px; border-radius: 10px; max-width: 80%; align-self: flex-start; }
    .user-msg { background: #4361ee; color: #fff; padding: 10px; border-radius: 10px; max-width: 80%; align-self: flex-end; }
    .chatbot-input-area { padding: 15px; display: flex; gap: 10px; background: rgba(0,0,0,0.2); }
    #chatbot-input-store { flex: 1; background: rgba(255,255,255,0.1); border: none; padding: 10px; border-radius: 5px; color: white; }
    #chatbot-send-store { background: #f72585; border: none; width: 40px; border-radius: 5px; color: white; cursor: pointer; }
</style>
{% endblock %}
