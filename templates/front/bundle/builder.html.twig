{% extends 'base.html.twig' %}

{% block title %}Build Your Own Bundle – E-Sportify{% endblock %}

{% block body %}
<section class="shop-hero bundle-hero">
    <div class="shop-hero-inner">
        <div class="shop-kicker">Pack Personnalisé</div>
        <h1 class="shop-title">
            <i class="fas fa-magic"></i> Créez votre Setup Gamer
        </h1>
        <p class="shop-lead">Sélectionnez 3 accessoires et profitez d'une remise pack exclusive !</p>
    </div>
    <div class="shop-hero-glow"></div>
</section>

<section class="bundle-builder-container">
    {# PROGRESS BAR #}
    <div class="bundle-progress-wrapper">
        <div class="bundle-progress-track">
            <div class="bundle-progress-fill" id="progress-fill" style="width: 33%;"></div>
        </div>
        <div class="bundle-steps">
            {% for i, step in steps %}
            <div class="bundle-step" data-step="{{ i + 1 }}" id="step-indicator-{{ i + 1 }}">
                <div class="step-icon">
                    <i class="{{ step.icon }}"></i>
                </div>
                <div class="step-label">{{ step.name }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    {# SELECTION AREA #}
    <form action="{{ path('front_bundle_add_to_cart') }}" method="POST" id="bundle-form">
        <div class="selection-panels">
            {% for i, step in steps %}
            <div class="selection-panel {% if i == 0 %}active{% endif %}" id="panel-{{ i + 1 }}">
                <div class="panel-header">
                    <h2>Étape {{ i + 1 }} : Choisissez votre {{ step.name }}</h2>
                </div>
                
                <div class="bundle-grid">
                    {% for p in selection[step.name] %}
                    <div class="bundle-item-card" data-product-id="{{ p.id }}" data-price="{{ p.prix }}" data-name="{{ p.nom }}" onclick="selectProduct({{ i + 1 }}, this)">
                        <div class="card-inner">
                            <div class="card-img-wrapper">
                                <img src="/uploads/produits/{{ p.image }}" alt="{{ p.nom }}">
                            </div>
                            <div class="card-content">
                                <h3>{{ p.nom }}</h3>
                                <div class="card-price">{{ p.prix }} €</div>
                            </div>
                            <div class="selection-marker">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="empty-state">Aucun produit disponible dans cette catégorie.</p>
                    {% endfor %}
                </div>
                
                <input type="hidden" name="products[]" id="input-step-{{ i + 1 }}" value="">

                <div class="panel-actions">
                    {% if i > 0 %}
                    <button type="button" class="btn-builder prev" onclick="changeStep({{ i + 1 }}, {{ i }})">
                        <i class="fas fa-chevron-left"></i> Précédent
                    </button>
                    {% endif %}
                    
                    {% if i < steps|length - 1 %}
                    <button type="button" class="btn-builder next" id="btn-next-{{ i + 1 }}" disabled onclick="changeStep({{ i + 1 }}, {{ i + 2 }})">
                        Suivant <i class="fas fa-chevron-right"></i>
                    </button>
                    {% else %}
                    <button type="submit" class="btn-builder final" id="btn-submit" disabled>
                        <i class="fas fa-shopping-basket"></i> Finaliser mon Pack
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </form>

    {# SUMMARY BAR #}
    <div class="bundle-summary-bar" id="summary-bar">
        <div class="summary-content">
            <div class="summary-items" id="summary-items">
                {# Dynamically populated #}
            </div>
            <div class="summary-total">
                <div class="total-label">Total du Pack</div>
                <div class="total-price-wrapper">
                    <span class="old-price" id="original-total">0 €</span>
                    <span class="new-price" id="bundle-total">0 €</span>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .bundle-hero { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); padding: 4rem 6%; }
    .bundle-builder-container { max-width: 1200px; margin: -50px auto 100px; padding: 0 20px; position: relative; z-index: 10; }
    
    /* Progress Bar */
    .bundle-progress-wrapper { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 30px; margin-bottom: 40px; backdrop-filter: blur(10px); }
    .bundle-progress-track { height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; position: relative; margin: 20px 0; }
    .bundle-progress-fill { position: absolute; top: 0; left: 0; height: 100%; border-radius: 3px; background: linear-gradient(90deg, #4361ee, #4cc9f0); box-shadow: 0 0 15px rgba(76,201,240,0.5); transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    .bundle-steps { display: flex; justify-content: space-between; position: relative; }
    .bundle-step { display: flex; flex-direction: column; align-items: center; gap: 10px; opacity: 0.4; transition: all 0.3s; }
    .bundle-step.active { opacity: 1; }
    .bundle-step.completed { opacity: 1; color: #4cc9f0; }
    .step-icon { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid transparent; transition: all 0.3s; }
    .bundle-step.active .step-icon { border-color: #4cc9f0; background: rgba(76,201,240,0.1); transform: scale(1.1); }
    .bundle-step.completed .step-icon { background: #4cc9f0; color: #0f172a; }
    .step-label { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

    /* Panels */
    .selection-panel { display: none; animation: fadeIn 0.4s ease-out; }
    .selection-panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .panel-header h2 { font-size: 24px; color: white; margin-bottom: 30px; text-align: center; }

    /* Item Grid */
    .bundle-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .bundle-item-card { background: rgba(255,255,255,0.02); border: 2px solid rgba(255,255,255,0.05); border-radius: 15px; cursor: pointer; transition: all 0.3s; overflow: hidden; }
    .bundle-item-card:hover { transform: translateY(-5px); border-color: rgba(76,201,240,0.3); background: rgba(255,255,255,0.04); }
    .bundle-item-card.selected { border-color: #4cc9f0; background: rgba(76,201,240,0.15); box-shadow: 0 10px 30px rgba(76,201,240,0.2); }
    .card-img-wrapper { height: 180px; padding: 20px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); }
    .card-img-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .card-content { padding: 20px; text-align: center; }
    .card-content h3 { font-size: 16px; margin: 0 0 10px; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .card-price { font-size: 18px; font-weight: 800; color: #4cc9f0; }
    .selection-marker { position: absolute; top: 10px; right: 10px; color: #4cc9f0; font-size: 24px; opacity: 0; transform: scale(0.5); transition: all 0.3s; }
    .bundle-item-card.selected .selection-marker { opacity: 1; transform: scale(1); }

    /* Actions */
    .panel-actions { margin-top: 50px; display: flex; justify-content: center; gap: 20px; }
    .btn-builder { padding: 15px 40px; border-radius: 12px; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: all 0.3s; border: none; display: flex; align-items: center; gap: 10px; }
    .btn-builder.next { background: #4cc9f0; color: #0f172a; }
    .btn-builder.next:disabled { opacity: 0.3; cursor: not-allowed; }
    .btn-builder.prev { background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); }
    .btn-builder.final { background: linear-gradient(135deg, #f72585, #ff006e); color: white; box-shadow: 0 10px 20px rgba(247,37,133,0.3); }

    /* Summary Bar */
    .bundle-summary-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); width: 90%; max-width: 1000px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border: 2px solid #4cc9f0; border-radius: 20px; padding: 20px 40px; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .bundle-summary-bar.visible { transform: translateX(-50%) translateY(0); }
    .summary-content { display: flex; justify-content: space-between; align-items: center; }
    .summary-items { display: flex; gap: 15px; }
    .summary-item-bubble { width: 50px; height: 50px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; position: relative; }
    .summary-item-bubble img { max-width: 80%; max-height: 80%; object-fit: contain; }
    .summary-total { text-align: right; }
    .total-label { font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; }
    .total-price-wrapper { display: flex; align-items: center; gap: 15px; }
    .old-price { text-decoration: line-through; color: rgba(255,255,255,0.3); font-size: 16px; font-weight: 600; }
    .new-price { color: #f72585; font-size: 28px; font-weight: 900; }
</style>

<script>
    let currentSelection = {
        1: null,
        2: null,
        3: null
    };

    function selectProduct(step, element) {
        // Remove selection from others in the same step
        const stepPanel = document.getElementById(`panel-${step}`);
        stepPanel.querySelectorAll('.bundle-item-card').forEach(card => card.classList.remove('selected'));
        
        // Mark as selected
        element.classList.add('selected');
        
        // Store data
        currentSelection[step] = {
            id: element.dataset.productId,
            name: element.dataset.name,
            price: parseFloat(element.dataset.price),
            image: element.querySelector('img').src
        };
        
        // Update hidden input
        document.getElementById(`input-step-${step}`).value = element.dataset.productId;
        
        // Update UI
        updateSummary();
        
        // Enable next button
        const nextBtn = document.getElementById(step === 3 ? 'btn-submit' : `btn-next-${step}`);
        if(nextBtn) nextBtn.disabled = false;
        
        // Mark step as completed in progress bar
        document.getElementById(`step-indicator-${step}`).classList.add('completed');
    }

    function changeStep(from, to) {
        document.getElementById(`panel-${from}`).classList.remove('active');
        document.getElementById(`panel-${to}`).classList.add('active');
        
        // Update progress bar
        const progress = (to / 3) * 100;
        document.getElementById('progress-fill').style.width = `${progress}%`;
        
        // Update indicators
        for(let i=1; i<=3; i++) {
            const el = document.getElementById(`step-indicator-${i}`);
            if(i === to) el.classList.add('active');
            else el.classList.remove('active');
        }
        
        window.scrollTo({ top: 200, behavior: 'smooth' });
    }

    function updateSummary() {
        const summaryBar = document.getElementById('summary-bar');
        const summaryItems = document.getElementById('summary-items');
        const originalTotalEl = document.getElementById('original-total');
        const bundleTotalEl = document.getElementById('bundle-total');
        
        let total = 0;
        let count = 0;
        
        summaryItems.innerHTML = '';
        
        for(let i=1; i<=3; i++) {
            const p = currentSelection[i];
            if(p) {
                count++;
                total += p.price;
                summaryItems.innerHTML += `
                    <div class="summary-item-bubble animated zoomIn">
                        <img src="${p.image}" title="${p.name}">
                    </div>
                `;
            } else {
                summaryItems.innerHTML += `
                    <div class="summary-item-bubble empty">
                        <i class="fas fa-plus" style="color: rgba(255,255,255,0.1)"></i>
                    </div>
                `;
            }
        }
        
        if(count > 0) {
            summaryBar.classList.add('visible');
            originalTotalEl.innerText = `${total.toFixed(2)} €`;
            
            // Promotion: -10% if 2 items, -15% if 3 items
            let discount = count === 3 ? 0.85 : (count === 2 ? 0.90 : 1);
            let bundleTotal = total * discount;
            
            bundleTotalEl.innerText = `${bundleTotal.toFixed(2)} €`;
            
            if(count < 2) originalTotalEl.style.display = 'none';
            else originalTotalEl.style.display = 'inline';
        }
    }
</script>
{% endblock %}
