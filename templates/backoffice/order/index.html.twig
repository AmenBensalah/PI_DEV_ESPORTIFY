{% extends 'admin/layout.html.twig' %}

{% block title %}Commandes - Admin{% endblock %}
{% block page_title %}Commandes{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Gestion des Commandes</h2>
        <p class="admin-tournament-lead">Suivez les commandes, leurs statuts et les actions associées.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('admin_order_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="#" class="tab active" data-status="">Toutes</a>
        <a href="#" class="tab" data-status="pending">En cours</a>
        <a href="#" class="tab" data-status="paid">Validées</a>
        <a href="#" class="tab" data-status="cancelled">Annulées</a>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form class="admin-tournament-form" data-filter-form>
            <div class="field">
                <label>Recherche</label>
                <input type="text" name="q" placeholder="ID, nom, prénom, statut...">
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="status">
                    <option value="">-- Tous --</option>
                    <option value="pending">En cours</option>
                    <option value="paid">Validée</option>
                    <option value="cancelled">Annulée</option>
                </select>
            </div>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <button type="reset" class="admin-tournament-btn ghost">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </button>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="#" data-sort="id:desc">ID ↓</a>
            <a href="#" data-sort="id:asc">ID ↑</a>
            <a href="#" data-sort="nom:asc">Nom A→Z</a>
            <a href="#" data-sort="nom:desc">Nom Z→A</a>
            <a href="#" data-sort="statut:asc">Statut A→Z</a>
            <a href="#" data-sort="statut:desc">Statut Z→A</a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="admin-tournament-alert success">
            <i class="fas fa-check-circle"></i> {{ message }}
        </div>
    {% endfor %}

    <div class="admin-tournament-table">
        <table data-table="orders">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom</th>
                    <th>Prénom</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for commande in commandes %}
                <tr class="admin-tournament-row"
                    data-search="{{ commande.id }} {{ commande.nom }} {{ commande.prenom }} {{ commande.statut }}"
                    data-id="{{ commande.id }}"
                    data-nom="{{ commande.nom }}"
                    data-statut="{{ commande.statut }}">
                    <td>{{ commande.id }}</td>
                    <td>{{ commande.nom }}</td>
                    <td>{{ commande.prenom }}</td>
                    <td>
                        {% if commande.statut == 'paid' %}
                            <span class="badge badge-success">Validée</span>
                        {% elseif commande.statut == 'pending' or commande.statut == 'pending_payment' %}
                            <span class="badge badge-warn">En cours</span>
                        {% elseif commande.statut == 'cancelled' %}
                            <span class="badge badge-danger">Annulée</span>
                        {% else %}
                            <span class="badge badge-info">{{ commande.statut }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="admin-tournament-row-actions">
                            <a href="{{ path('admin_order_show', {'id': commande.id}) }}" class="admin-tournament-icon" title="Voir">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ path('admin_order_edit', {'id': commande.id}) }}" class="admin-tournament-icon cyan" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% if commande.statut == 'cancelled' %}
                                <form action="{{ path('admin_order_delete', {'id': commande.id}) }}" method="post" onsubmit="return confirm('Supprimer cette commande ?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete_order' ~ commande.id) }}">
                                    <button type="submit" class="admin-tournament-icon danger" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            {% else %}
                                <span class="admin-tournament-icon danger disabled" title="Suppression indisponible">
                                    <i class="fas fa-trash"></i>
                                </span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="5">Aucune commande</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('[data-filter-form]');
        const tabs = document.querySelectorAll('.admin-tournament-tabs .tab');
        const rows = Array.from(document.querySelectorAll('[data-table=\"orders\"] tbody tr'));
        const sortLinks = document.querySelectorAll('.admin-tournament-sort a[data-sort]');

        const applyFilters = () => {
            const formData = new FormData(form);
            const query = (formData.get('q') || '').toLowerCase();
            const status = (formData.get('status') || '').toLowerCase();

            rows.forEach(row => {
                const search = (row.dataset.search || '').toLowerCase();
                const rowStatus = (row.dataset.statut || '').toLowerCase();
                const matchesQuery = !query || search.includes(query);
                const matchesStatus = !status || rowStatus.includes(status);
                row.style.display = matchesQuery && matchesStatus ? '' : 'none';
            });
        };

        const applySort = (field, direction) => {
            const tbody = rows[0] ? rows[0].closest('tbody') : null;
            if (!tbody) {
                return;
            }
            const sorted = rows.slice().sort((a, b) => {
                let aVal = '';
                let bVal = '';
                if (field === 'id') {
                    aVal = parseInt(a.dataset.id || '0', 10);
                    bVal = parseInt(b.dataset.id || '0', 10);
                    return direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                if (field === 'nom') {
                    aVal = a.dataset.nom || '';
                    bVal = b.dataset.nom || '';
                } else if (field === 'statut') {
                    aVal = a.dataset.statut || '';
                    bVal = b.dataset.statut || '';
                }
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });
            sorted.forEach(row => tbody.appendChild(row));
        };

        if (form) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                applyFilters();
            });
            form.addEventListener('reset', () => {
                setTimeout(() => {
                    tabs.forEach(tab => tab.classList.remove('active'));
                    if (tabs[0]) {
                        tabs[0].classList.add('active');
                    }
                    applyFilters();
                }, 0);
            });
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', (event) => {
                event.preventDefault();
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                if (form) {
                    form.querySelector('select[name=\"status\"]').value = tab.dataset.status || '';
                    applyFilters();
                }
            });
        });

        sortLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const [field, direction] = (link.dataset.sort || '').split(':');
                applySort(field, direction);
            });
        });
    });
</script>
{% endblock %}
