{% extends 'admin/layout.html.twig' %}

{% block title %}Paiements - Admin{% endblock %}
{% block page_title %}Paiements{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Gestion des Paiements</h2>
        <p class="admin-tournament-lead">Suivez les transactions, montants et statuts.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('admin_payment_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="#" class="tab {{ currentStatus is empty ? 'active' : '' }}" data-status="">Tous</a>
        <a href="#" class="tab {{ currentStatus == 'succeeded' ? 'active' : '' }}" data-status="succeeded">Validés</a>
        <a href="#" class="tab {{ currentStatus == 'pending' ? 'active' : '' }}" data-status="pending">En attente</a>
        <a href="#" class="tab {{ currentStatus == 'failed' ? 'active' : '' }}" data-status="failed">Échoués</a>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form method="GET" action="{{ path('admin_payment_index') }}" class="admin-tournament-form" data-payments-form>
            <div class="field">
                <label>Recherche</label>
                <input type="text" name="q" placeholder="ID, commande, statut..." value="{{ currentQuery|default('') }}">
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="status">
                    <option value="">-- Tous --</option>
                    <option value="succeeded" {% if currentStatus == 'succeeded' %}selected{% endif %}>Validé</option>
                    <option value="pending" {% if currentStatus == 'pending' %}selected{% endif %}>En attente</option>
                    <option value="failed" {% if currentStatus == 'failed' %}selected{% endif %}>Échoué</option>
                </select>
            </div>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <button type="reset" class="admin-tournament-btn ghost">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </button>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="#" data-sort="id:DESC" class="{{ currentSort == 'id' and currentDirection == 'DESC' ? 'active' : '' }}">ID ↓</a>
            <a href="#" data-sort="id:ASC" class="{{ currentSort == 'id' and currentDirection == 'ASC' ? 'active' : '' }}">ID ↑</a>
            <a href="#" data-sort="montant:DESC" class="{{ currentSort == 'montant' and currentDirection == 'DESC' ? 'active' : '' }}">Montant ↓</a>
            <a href="#" data-sort="montant:ASC" class="{{ currentSort == 'montant' and currentDirection == 'ASC' ? 'active' : '' }}">Montant ↑</a>
            <a href="#" data-sort="date:DESC" class="{{ currentSort == 'date' and currentDirection == 'DESC' ? 'active' : '' }}">Date ↓</a>
            <a href="#" data-sort="date:ASC" class="{{ currentSort == 'date' and currentDirection == 'ASC' ? 'active' : '' }}">Date ↑</a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="admin-tournament-alert success">
            <i class="fas fa-check-circle"></i> {{ message }}
        </div>
    {% endfor %}

    <div id="admin-payments-results" data-sort="{{ currentSort|default('id') }}" data-direction="{{ currentDirection|default('DESC') }}">
        {% include 'backoffice/payment/_table.html.twig' with { payments: payments } %}
    </div>
</section>

<script>
(() => {
    const form = document.querySelector('[data-payments-form]');
    const queryInput = form?.querySelector('input[name="q"]');
    const statusSelect = form?.querySelector('select[name="status"]');
    const tabs = document.querySelectorAll('.admin-tournament-tabs .tab');
    const sortLinks = document.querySelectorAll('.admin-tournament-sort a[data-sort]');
    const results = document.getElementById('admin-payments-results');
    if (!form || !queryInput || !statusSelect || !results) {
        return;
    }

    let debounceTimer = null;
    let currentRequest = null;

    const updateSortActive = () => {
        const current = `${results.dataset.sort || 'id'}:${(results.dataset.direction || 'DESC').toUpperCase()}`;
        sortLinks.forEach((link) => {
            link.classList.toggle('active', (link.dataset.sort || '').toUpperCase() === current);
        });
    };

    const updateTabsActive = () => {
        const currentStatus = (statusSelect.value || '').toLowerCase();
        tabs.forEach((tab) => {
            tab.classList.toggle('active', (tab.dataset.status || '').toLowerCase() === currentStatus);
        });
    };

    const buildUrl = (includeAjax = true) => {
        const params = new URLSearchParams();
        const query = queryInput.value.trim();
        const status = statusSelect.value;
        const sort = results.dataset.sort || 'id';
        const direction = (results.dataset.direction || 'DESC').toUpperCase();

        if (query !== '') {
            params.set('q', query);
        }
        if (status !== '') {
            params.set('status', status);
        }
        params.set('sort', sort);
        params.set('direction', direction);
        if (includeAjax) {
            params.set('ajax', '1');
        }

        return `${form.action || window.location.pathname}?${params.toString()}`;
    };

    const updateBrowserUrl = () => {
        const cleanUrl = buildUrl(false);
        const cleanParams = cleanUrl.split('?')[1] || '';
        if (cleanParams === '') {
            window.history.replaceState({}, '', window.location.pathname);
            return;
        }
        window.history.replaceState({}, '', cleanUrl);
    };

    const fetchResults = () => {
        if (currentRequest) {
            currentRequest.abort();
        }

        const controller = new AbortController();
        currentRequest = controller;
        results.classList.add('is-loading');

        fetch(buildUrl(true), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            signal: controller.signal,
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error('Request failed');
                }
                return response.text();
            })
            .then((html) => {
                results.innerHTML = html;
                results.classList.remove('is-loading');
                updateSortActive();
                updateTabsActive();
                updateBrowserUrl();
            })
            .catch((error) => {
                if (error.name !== 'AbortError') {
                    results.classList.remove('is-loading');
                }
            });
    };

    const scheduleFetch = () => {
        window.clearTimeout(debounceTimer);
        debounceTimer = window.setTimeout(fetchResults, 250);
    };

    queryInput.addEventListener('input', scheduleFetch);
    statusSelect.addEventListener('change', fetchResults);
    form.addEventListener('submit', (event) => {
        event.preventDefault();
        fetchResults();
    });
    form.addEventListener('reset', () => {
        window.setTimeout(() => {
            results.dataset.sort = 'id';
            results.dataset.direction = 'DESC';
            statusSelect.value = '';
            updateSortActive();
            updateTabsActive();
            fetchResults();
        }, 0);
    });

    tabs.forEach((tab) => {
        tab.addEventListener('click', (event) => {
            event.preventDefault();
            statusSelect.value = tab.dataset.status || '';
            updateTabsActive();
            fetchResults();
        });
    });

    sortLinks.forEach((link) => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const [field, direction] = (link.dataset.sort || '').split(':');
            if (!field || !direction) {
                return;
            }

            results.dataset.sort = field;
            results.dataset.direction = direction.toUpperCase();
            updateSortActive();
            fetchResults();
        });
    });

    updateSortActive();
    updateTabsActive();
})();
</script>
{% endblock %}
