{% extends 'admin/layout.html.twig' %}

{% block title %}Paiements - Admin{% endblock %}
{% block page_title %}Paiements{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Gestion des Paiements</h2>
        <p class="admin-tournament-lead">Suivez les transactions, montants et statuts.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('admin_payment_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="#" class="tab active" data-status="">Tous</a>
        <a href="#" class="tab" data-status="succeeded">Validés</a>
        <a href="#" class="tab" data-status="pending">En attente</a>
        <a href="#" class="tab" data-status="failed">Échoués</a>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form class="admin-tournament-form" data-filter-form>
            <div class="field">
                <label>Recherche</label>
                <input type="text" name="q" placeholder="ID, commande, statut...">
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="status">
                    <option value="">-- Tous --</option>
                    <option value="succeeded">Validé</option>
                    <option value="pending">En attente</option>
                    <option value="failed">Échoué</option>
                </select>
            </div>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <button type="reset" class="admin-tournament-btn ghost">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </button>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="#" data-sort="id:desc">ID ↓</a>
            <a href="#" data-sort="id:asc">ID ↑</a>
            <a href="#" data-sort="montant:desc">Montant ↓</a>
            <a href="#" data-sort="montant:asc">Montant ↑</a>
            <a href="#" data-sort="date:desc">Date ↓</a>
            <a href="#" data-sort="date:asc">Date ↑</a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="admin-tournament-alert success">
            <i class="fas fa-check-circle"></i> {{ message }}
        </div>
    {% endfor %}

    <div class="admin-tournament-table">
        <table data-table="payments">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Commande</th>
                    <th>Montant</th>
                    <th>Statut</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for payment in payments %}
                <tr class="admin-tournament-row"
                    data-search="{{ payment.id }} {{ payment.commande.id }} {{ payment.amount }} {{ payment.status }} {{ payment.createdAt|date('Y-m-d H:i') }}"
                    data-id="{{ payment.id }}"
                    data-montant="{{ payment.amount }}"
                    data-statut="{{ payment.status }}"
                    data-date="{{ payment.createdAt ? payment.createdAt|date('YmdHis') : '' }}">
                    <td>{{ payment.id }}</td>
                    <td>{{ payment.commande.id }}</td>
                    <td>{{ payment.amount / 100 }} EUR</td>
                    <td>
                        {% if payment.status matches '/success|succeeded|paid/' %}
                            <span class="badge badge-success">Validé</span>
                        {% elseif payment.status matches '/pending/' %}
                            <span class="badge badge-warn">En attente</span>
                        {% elseif payment.status matches '/failed|cancel/' %}
                            <span class="badge badge-danger">Échoué</span>
                        {% else %}
                            <span class="badge badge-info">{{ payment.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ payment.createdAt|date('d/m/Y H:i') }}</td>
                    <td>
                        <div class="admin-tournament-row-actions">
                            <a href="{{ path('admin_payment_show', {'id': payment.id}) }}" class="admin-tournament-icon" title="Voir">
                                <i class="fas fa-eye"></i>
                            </a>
                            <span class="admin-tournament-icon cyan disabled" title="Modification indisponible">
                                <i class="fas fa-edit"></i>
                            </span>
                            <span class="admin-tournament-icon danger disabled" title="Suppression indisponible">
                                <i class="fas fa-trash"></i>
                            </span>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="6">Aucun paiement</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('[data-filter-form]');
        const tabs = document.querySelectorAll('.admin-tournament-tabs .tab');
        const rows = Array.from(document.querySelectorAll('[data-table=\"payments\"] tbody tr'));
        const sortLinks = document.querySelectorAll('.admin-tournament-sort a[data-sort]');

        const applyFilters = () => {
            const formData = new FormData(form);
            const query = (formData.get('q') || '').toLowerCase();
            const status = (formData.get('status') || '').toLowerCase();

            rows.forEach(row => {
                const search = (row.dataset.search || '').toLowerCase();
                const rowStatus = (row.dataset.statut || '').toLowerCase();
                const matchesQuery = !query || search.includes(query);
                const matchesStatus = !status || rowStatus.includes(status);
                row.style.display = matchesQuery && matchesStatus ? '' : 'none';
            });
        };

        const applySort = (field, direction) => {
            const tbody = rows[0] ? rows[0].closest('tbody') : null;
            if (!tbody) {
                return;
            }
            const sorted = rows.slice().sort((a, b) => {
                let aVal = '';
                let bVal = '';
                if (field === 'id') {
                    aVal = parseInt(a.dataset.id || '0', 10);
                    bVal = parseInt(b.dataset.id || '0', 10);
                    return direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                if (field === 'montant') {
                    aVal = parseInt(a.dataset.montant || '0', 10);
                    bVal = parseInt(b.dataset.montant || '0', 10);
                    return direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                if (field === 'date') {
                    aVal = a.dataset.date || '';
                    bVal = b.dataset.date || '';
                    return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return 0;
            });
            sorted.forEach(row => tbody.appendChild(row));
        };

        if (form) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                applyFilters();
            });
            form.addEventListener('reset', () => {
                setTimeout(() => {
                    tabs.forEach(tab => tab.classList.remove('active'));
                    if (tabs[0]) {
                        tabs[0].classList.add('active');
                    }
                    applyFilters();
                }, 0);
            });
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', (event) => {
                event.preventDefault();
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                if (form) {
                    form.querySelector('select[name=\"status\"]').value = tab.dataset.status || '';
                    applyFilters();
                }
            });
        });

        sortLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const [field, direction] = (link.dataset.sort || '').split(':');
                applySort(field, direction);
            });
        });
    });
</script>
{% endblock %}
