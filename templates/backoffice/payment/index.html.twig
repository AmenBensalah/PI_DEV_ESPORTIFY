{% extends 'admin/layout.html.twig' %}

{% block title %}Paiements - Admin{% endblock %}
{% block page_title %}Paiements{% endblock %}

{% block body %}
<section class="admin-tournament-hero">
    <div class="admin-tournament-hero-inner">
        <div class="admin-tournament-kicker">Admin</div>
        <h2 class="admin-tournament-title">Gestion des Paiements</h2>
        <p class="admin-tournament-lead">Suivez les transactions, montants et statuts.</p>
        <div class="admin-tournament-hero-actions">
            <a href="{{ path('admin_payment_index') }}" class="admin-tournament-btn ghost">
                <i class="fas fa-rotate"></i> Rafraîchir
            </a>
        </div>
    </div>
    <div class="admin-tournament-hero-glow"></div>
</section>

{% set failureRate = analytics.failure.failure_rate|default(0) %}
{% set successRate = analytics.failure.success_rate|default(0) %}
{% set pendingRate = analytics.failure.pending_rate|default(0) %}
{% set revenueTrend = analytics.revenue.trend_percent|default(0) %}
{% set ordersTrend = analytics.paid_orders.trend_percent|default(0) %}
{% set modelSource = analytics.model.source|default('heuristic_baseline') %}
{% set modelBadgeClass = modelSource == 'ml_forecast_model' ? 'ml' : 'fallback' %}

<section class="payment-forecast-shell">
    <div class="payment-model-badge {{ modelBadgeClass }}">
        Mode prediction: {{ modelSource == 'ml_forecast_model' ? 'ML entraine' : 'Fallback heuristique' }}
    </div>
    <div class="payment-kpi-grid">
        <article class="payment-kpi-card">
            <div class="kpi-label">Prevision Chiffre d'affaires</div>
            <div class="kpi-main">{{ analytics.revenue.forecast_day|number_format(2, '.', ' ') }} EUR</div>
            <div class="kpi-sub">Jour suivant</div>
            <div class="kpi-split">
                <div>
                    <span>Semaine</span>
                    <strong>{{ analytics.revenue.forecast_week|number_format(2, '.', ' ') }} EUR</strong>
                </div>
                <div>
                    <span>Mois</span>
                    <strong>{{ analytics.revenue.forecast_month|number_format(2, '.', ' ') }} EUR</strong>
                </div>
            </div>
            <div class="kpi-trend {{ revenueTrend >= 0 ? 'up' : 'down' }}">
                Tendance 7j: {{ revenueTrend >= 0 ? '+' : '' }}{{ revenueTrend|number_format(2, '.', ' ') }}%
            </div>
        </article>

        <article class="payment-kpi-card">
            <div class="kpi-label">Commandes payees (prediction)</div>
            <div class="kpi-main">{{ analytics.paid_orders.forecast_day|default(0) }}</div>
            <div class="kpi-sub">Commandes pour le prochain jour</div>
            <div class="kpi-split">
                <div>
                    <span>Semaine</span>
                    <strong>{{ analytics.paid_orders.forecast_week|default(0) }}</strong>
                </div>
                <div>
                    <span>Mois</span>
                    <strong>{{ analytics.paid_orders.forecast_month|default(0) }}</strong>
                </div>
            </div>
            <div class="kpi-trend {{ ordersTrend >= 0 ? 'up' : 'down' }}">
                Tendance 7j: {{ ordersTrend >= 0 ? '+' : '' }}{{ ordersTrend|number_format(2, '.', ' ') }}%
            </div>
        </article>

        <article class="payment-kpi-card">
            <div class="kpi-label">Taux d'echec de paiement</div>
            <div class="kpi-main danger">{{ failureRate|number_format(2, '.', ' ') }}%</div>
            <div class="kpi-sub">Base statuts commandes: paid / cancelled / pending_payment</div>
            <div class="kpi-rates">
                <div><span>Succes</span><strong>{{ successRate|number_format(2, '.', ' ') }}%</strong></div>
                <div><span>En attente</span><strong>{{ pendingRate|number_format(2, '.', ' ') }}%</strong></div>
            </div>
            <div class="kpi-sub" style="margin-top:6px;">
                Prevision J+1: {{ analytics.failure.forecast_day|default(0)|number_format(2, '.', ' ') }}%
            </div>
            <div class="kpi-progress">
                <div class="bar success" style="width: {{ successRate }}%"></div>
                <div class="bar pending" style="width: {{ pendingRate }}%"></div>
                <div class="bar danger" style="width: {{ failureRate }}%"></div>
            </div>
        </article>

        <article class="payment-kpi-card">
            <div class="kpi-label">Snapshot actuel</div>
            <div class="kpi-metrics">
                <div><span>CA aujourd'hui</span><strong>{{ analytics.revenue.today|number_format(2, '.', ' ') }} EUR</strong></div>
                <div><span>CA 7 jours</span><strong>{{ analytics.revenue.last7|number_format(2, '.', ' ') }} EUR</strong></div>
                <div><span>CA 30 jours</span><strong>{{ analytics.revenue.last30|number_format(2, '.', ' ') }} EUR</strong></div>
                <div><span>Commandes payees (statut)</span><strong>{{ analytics.paid_orders.from_status_paid|default(0) }}</strong></div>
            </div>
            <div class="kpi-generated">
                Mis a jour: {{ analytics.generatedAt|date('d/m/Y H:i') }}
            </div>
        </article>
    </div>

    <div class="payment-series-grid">
        <article class="series-card">
            <h3>Distribution horaire (paiements valides)</h3>
            <div class="series-list">
                {% for row in analytics.series.hourly %}
                    <div class="series-row">
                        <div class="series-label">{{ row.label }}</div>
                        <div class="series-bar-wrap">
                            <div class="series-bar revenue" style="width: {{ row.revenue_pct }}%"></div>
                        </div>
                        <div class="series-values">
                            <strong>{{ row.revenue|number_format(2, '.', ' ') }} EUR</strong>
                            <span>{{ row.orders }} cmd</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </article>

        <article class="series-card">
            <h3>Evolution journaliere (14 jours)</h3>
            <div class="series-list">
                {% for row in analytics.series.daily %}
                    <div class="series-row">
                        <div class="series-label">{{ row.label }}</div>
                        <div class="series-bar-wrap">
                            <div class="series-bar orders" style="width: {{ row.orders_pct }}%"></div>
                        </div>
                        <div class="series-values">
                            <strong>{{ row.orders }} cmd</strong>
                            <span>{{ row.revenue|number_format(2, '.', ' ') }} EUR</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </article>

        <article class="series-card">
            <h3>Evolution hebdomadaire (8 semaines)</h3>
            <div class="series-list">
                {% for row in analytics.series.weekly %}
                    <div class="series-row">
                        <div class="series-label">{{ row.label }}</div>
                        <div class="series-bar-wrap">
                            <div class="series-bar revenue" style="width: {{ row.revenue_pct }}%"></div>
                        </div>
                        <div class="series-values">
                            <strong>{{ row.revenue|number_format(2, '.', ' ') }} EUR</strong>
                            <span>{{ row.orders }} cmd</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </article>
    </div>
</section>

<section class="admin-tournament-shell">
    <div class="admin-tournament-tabs">
        <a href="#" class="tab {{ currentStatus is empty ? 'active' : '' }}" data-status="">Tous</a>
        <a href="#" class="tab {{ currentStatus == 'succeeded' ? 'active' : '' }}" data-status="succeeded">Validés</a>
        <a href="#" class="tab {{ currentStatus == 'pending' ? 'active' : '' }}" data-status="pending">En attente</a>
        <a href="#" class="tab {{ currentStatus == 'failed' ? 'active' : '' }}" data-status="failed">Échoués</a>
    </div>

    <div class="admin-tournament-panel">
        <div class="admin-tournament-panel-title">
            <i class="fas fa-search"></i>
            Recherche avancée
        </div>
        <form method="GET" action="{{ path('admin_payment_index') }}" class="admin-tournament-form" data-payments-form>
            <div class="field">
                <label>Recherche</label>
                <input type="text" name="q" placeholder="ID, commande, statut..." value="{{ currentQuery|default('') }}">
            </div>
            <div class="field">
                <label>Statut</label>
                <select name="status">
                    <option value="">-- Tous --</option>
                    <option value="succeeded" {% if currentStatus == 'succeeded' %}selected{% endif %}>Validé</option>
                    <option value="pending" {% if currentStatus == 'pending' %}selected{% endif %}>En attente</option>
                    <option value="failed" {% if currentStatus == 'failed' %}selected{% endif %}>Échoué</option>
                </select>
            </div>
            <div class="admin-tournament-actions">
                <button type="submit" class="admin-tournament-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <button type="reset" class="admin-tournament-btn ghost">
                    <i class="fas fa-rotate"></i> Réinitialiser
                </button>
            </div>
        </form>

        <div class="admin-tournament-sort">
            <span>Trier :</span>
            <a href="#" data-sort="id:DESC" class="{{ currentSort == 'id' and currentDirection == 'DESC' ? 'active' : '' }}">ID ↓</a>
            <a href="#" data-sort="id:ASC" class="{{ currentSort == 'id' and currentDirection == 'ASC' ? 'active' : '' }}">ID ↑</a>
            <a href="#" data-sort="montant:DESC" class="{{ currentSort == 'montant' and currentDirection == 'DESC' ? 'active' : '' }}">Montant ↓</a>
            <a href="#" data-sort="montant:ASC" class="{{ currentSort == 'montant' and currentDirection == 'ASC' ? 'active' : '' }}">Montant ↑</a>
            <a href="#" data-sort="date:DESC" class="{{ currentSort == 'date' and currentDirection == 'DESC' ? 'active' : '' }}">Date ↓</a>
            <a href="#" data-sort="date:ASC" class="{{ currentSort == 'date' and currentDirection == 'ASC' ? 'active' : '' }}">Date ↑</a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="admin-tournament-alert success">
            <i class="fas fa-check-circle"></i> {{ message }}
        </div>
    {% endfor %}

    <div id="admin-payments-results" data-sort="{{ currentSort|default('id') }}" data-direction="{{ currentDirection|default('DESC') }}">
        {% include 'backoffice/payment/_table.html.twig' with { payments: payments } %}
    </div>
</section>

<script>
(() => {
    const form = document.querySelector('[data-payments-form]');
    const queryInput = form?.querySelector('input[name="q"]');
    const statusSelect = form?.querySelector('select[name="status"]');
    const tabs = document.querySelectorAll('.admin-tournament-tabs .tab');
    const sortLinks = document.querySelectorAll('.admin-tournament-sort a[data-sort]');
    const results = document.getElementById('admin-payments-results');
    if (!form || !queryInput || !statusSelect || !results) {
        return;
    }

    let debounceTimer = null;
    let currentRequest = null;

    const updateSortActive = () => {
        const current = `${results.dataset.sort || 'id'}:${(results.dataset.direction || 'DESC').toUpperCase()}`;
        sortLinks.forEach((link) => {
            link.classList.toggle('active', (link.dataset.sort || '').toUpperCase() === current);
        });
    };

    const updateTabsActive = () => {
        const currentStatus = (statusSelect.value || '').toLowerCase();
        tabs.forEach((tab) => {
            tab.classList.toggle('active', (tab.dataset.status || '').toLowerCase() === currentStatus);
        });
    };

    const buildUrl = (includeAjax = true) => {
        const params = new URLSearchParams();
        const query = queryInput.value.trim();
        const status = statusSelect.value;
        const sort = results.dataset.sort || 'id';
        const direction = (results.dataset.direction || 'DESC').toUpperCase();

        if (query !== '') {
            params.set('q', query);
        }
        if (status !== '') {
            params.set('status', status);
        }
        params.set('sort', sort);
        params.set('direction', direction);
        if (includeAjax) {
            params.set('ajax', '1');
        }

        return `${form.action || window.location.pathname}?${params.toString()}`;
    };

    const updateBrowserUrl = () => {
        const cleanUrl = buildUrl(false);
        const cleanParams = cleanUrl.split('?')[1] || '';
        if (cleanParams === '') {
            window.history.replaceState({}, '', window.location.pathname);
            return;
        }
        window.history.replaceState({}, '', cleanUrl);
    };

    const fetchResults = () => {
        if (currentRequest) {
            currentRequest.abort();
        }

        const controller = new AbortController();
        currentRequest = controller;
        results.classList.add('is-loading');

        fetch(buildUrl(true), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            signal: controller.signal,
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error('Request failed');
                }
                return response.text();
            })
            .then((html) => {
                results.innerHTML = html;
                results.classList.remove('is-loading');
                updateSortActive();
                updateTabsActive();
                updateBrowserUrl();
            })
            .catch((error) => {
                if (error.name !== 'AbortError') {
                    results.classList.remove('is-loading');
                }
            });
    };

    const scheduleFetch = () => {
        window.clearTimeout(debounceTimer);
        debounceTimer = window.setTimeout(fetchResults, 250);
    };

    queryInput.addEventListener('input', scheduleFetch);
    statusSelect.addEventListener('change', fetchResults);
    form.addEventListener('submit', (event) => {
        event.preventDefault();
        fetchResults();
    });
    form.addEventListener('reset', () => {
        window.setTimeout(() => {
            results.dataset.sort = 'id';
            results.dataset.direction = 'DESC';
            statusSelect.value = '';
            updateSortActive();
            updateTabsActive();
            fetchResults();
        }, 0);
    });

    tabs.forEach((tab) => {
        tab.addEventListener('click', (event) => {
            event.preventDefault();
            statusSelect.value = tab.dataset.status || '';
            updateTabsActive();
            fetchResults();
        });
    });

    sortLinks.forEach((link) => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const [field, direction] = (link.dataset.sort || '').split(':');
            if (!field || !direction) {
                return;
            }

            results.dataset.sort = field;
            results.dataset.direction = direction.toUpperCase();
            updateSortActive();
            fetchResults();
        });
    });

    updateSortActive();
    updateTabsActive();
})();
</script>

<style>
.payment-forecast-shell {
    margin: 18px 0 20px;
    display: grid;
    gap: 16px;
}
.payment-model-badge {
    justify-self: start;
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.02em;
}
.payment-model-badge.ml {
    background: rgba(73, 219, 170, 0.16);
    border: 1px solid rgba(73, 219, 170, 0.4);
    color: #8cf2cb;
}
.payment-model-badge.fallback {
    background: rgba(245, 177, 73, 0.16);
    border: 1px solid rgba(245, 177, 73, 0.35);
    color: #ffd19f;
}
.payment-kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 12px;
}
.payment-kpi-card {
    background: linear-gradient(160deg, rgba(8, 18, 44, 0.88), rgba(10, 16, 34, 0.82));
    border: 1px solid rgba(112, 141, 255, 0.28);
    border-radius: 14px;
    padding: 14px;
    box-shadow: 0 12px 30px rgba(2, 10, 30, 0.28);
}
.kpi-label {
    color: #9fb4ea;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
}
.kpi-main {
    margin-top: 8px;
    color: #f3f7ff;
    font-size: 28px;
    font-weight: 700;
}
.kpi-main.danger {
    color: #ff879f;
}
.kpi-sub {
    margin-top: 4px;
    color: #8ea2d7;
    font-size: 12px;
}
.kpi-split {
    margin-top: 10px;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
}
.kpi-split div,
.kpi-rates div,
.kpi-metrics div {
    display: grid;
    gap: 2px;
}
.kpi-split span,
.kpi-rates span,
.kpi-metrics span {
    font-size: 11px;
    color: #8ea2d7;
}
.kpi-split strong,
.kpi-rates strong,
.kpi-metrics strong {
    color: #eef3ff;
    font-size: 14px;
}
.kpi-trend {
    margin-top: 10px;
    font-size: 12px;
    font-weight: 700;
}
.kpi-trend.up {
    color: #63e3a8;
}
.kpi-trend.down {
    color: #ff8ba1;
}
.kpi-rates {
    margin-top: 10px;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
}
.kpi-progress {
    margin-top: 10px;
    height: 8px;
    border-radius: 999px;
    overflow: hidden;
    display: flex;
    background: rgba(255, 255, 255, 0.08);
}
.kpi-progress .bar {
    height: 100%;
}
.kpi-progress .bar.success {
    background: #3ed7a7;
}
.kpi-progress .bar.pending {
    background: #f6bd40;
}
.kpi-progress .bar.danger {
    background: #ff6f91;
}
.kpi-metrics {
    margin-top: 10px;
    display: grid;
    gap: 6px;
}
.kpi-generated {
    margin-top: 10px;
    font-size: 12px;
    color: #9cb0e8;
}
.payment-series-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
}
.series-card {
    background: rgba(8, 16, 38, 0.84);
    border: 1px solid rgba(112, 141, 255, 0.22);
    border-radius: 14px;
    padding: 14px;
}
.series-card h3 {
    margin: 0 0 10px;
    color: #e9f0ff;
    font-size: 15px;
}
.series-list {
    display: grid;
    gap: 7px;
    max-height: 390px;
    overflow: auto;
    padding-right: 4px;
}
.series-row {
    display: grid;
    grid-template-columns: 52px 1fr 120px;
    align-items: center;
    gap: 8px;
}
.series-label {
    color: #a4b6e6;
    font-size: 12px;
    font-weight: 700;
}
.series-bar-wrap {
    height: 8px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.08);
    overflow: hidden;
}
.series-bar {
    height: 100%;
    border-radius: 999px;
}
.series-bar.revenue {
    background: linear-gradient(90deg, #59d6ff, #77b3ff);
}
.series-bar.orders {
    background: linear-gradient(90deg, #8ef7be, #62dca3);
}
.series-values {
    display: grid;
    text-align: right;
}
.series-values strong {
    color: #edf3ff;
    font-size: 12px;
}
.series-values span {
    color: #9cb0e8;
    font-size: 11px;
}
@media (max-width: 1400px) {
    .payment-kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .payment-series-grid {
        grid-template-columns: 1fr;
    }
}
@media (max-width: 900px) {
    .payment-kpi-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
